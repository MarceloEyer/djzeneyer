# ==============================================================================
# DJ ZEN EYER - PRODUCTION .htaccess v6.0 (FINAL STABLE)
# ==============================================================================

# ==============================================================================
# 1. LITESPEED CACHE (MANTIDO AUTOMÁTICO)
# ==============================================================================
# BEGIN LSCACHE
## LITESPEED WP CACHE PLUGIN - Do not edit the contents of this block! ##
<IfModule LiteSpeed>
RewriteEngine on
CacheLookup on
RewriteRule .* - [E=Cache-Control:no-autoflush]
RewriteRule litespeed/debug/.*\.log$ - [F,L]
RewriteRule \.litespeed_conf\.dat - [F,L]

### marker ASYNC start ###
RewriteCond %{REQUEST_URI} /wp-admin/admin-ajax\.php
RewriteCond %{QUERY_STRING} action=async_litespeed
RewriteRule .* - [E=noabort:1]
### marker ASYNC end ###

### marker MOBILE start ###
RewriteCond %{HTTP_USER_AGENT} Mobile|Android|Silk/|Kindle|BlackBerry|Opera\ Mini|Opera\ Mobi [NC]
RewriteRule .* - [E=Cache-Control:vary=%{ENV:LSCACHE_VARY_VALUE}+ismobile]
### marker MOBILE end ###

### marker NOCACHE COOKIES start ###
RewriteCond %{HTTP_COOKIE} wordpress_logged_in_|woocommerce_cart_hash|woocommerce_items_in_cart|wp_woocommerce_session_|wordpress_logged_in_\*|woocommerce_\*
RewriteRule .* - [E=Cache-Control:no-cache]
### marker NOCACHE COOKIES end ###

### marker NOCACHE USER AGENTS start ###
RewriteCond %{HTTP_USER_AGENT} /wp\-json/\*|/feed/\*|/comments/feed/\*|/api/\* [NC]
RewriteRule .* - [E=Cache-Control:no-cache]
### marker NOCACHE USER AGENTS end ###

### marker WEBP start ###
RewriteCond %{HTTP_ACCEPT} image/webp [OR]
RewriteCond %{HTTP_USER_AGENT} iPhone\ OS\ (1[4-9]|[2-9][0-9]) [OR]
RewriteCond %{HTTP_USER_AGENT} Firefox/([6-9][0-9]|[1-9][0-9]{2,})
RewriteRule .* - [E=Cache-Control:vary=%{ENV:LSCACHE_VARY_VALUE}+webp]
### marker WEBP end ###

### marker DROPQS start ###
CacheKeyModify -qs:fbclid
CacheKeyModify -qs:gclid
CacheKeyModify -qs:utm*
CacheKeyModify -qs:_ga
### marker DROPQS end ###

</IfModule>
## LITESPEED WP CACHE PLUGIN - Do not edit the contents of this block! ##
# END LSCACHE

# ==============================================================================
# 2. MIME TYPES (CRÍTICO PARA REACT/VITE)
# ==============================================================================
<IfModule mod_mime.c>
  AddType application/javascript .js .mjs
  AddType text/css .css
  AddType application/json .json .map
  AddType font/woff .woff
  AddType font/woff2 .woff2
  AddType font/ttf .ttf
  AddType font/otf .otf
  AddType image/svg+xml .svg .svgz
  AddType image/webp .webp
  AddType image/avif .avif
  AddType application/manifest+json .webmanifest
  AddCharset UTF-8 .html .css .js .xml .json
</IfModule>

# ==============================================================================
# 3. SECURITY HEADERS
# ==============================================================================
<IfModule mod_headers.c>
  Header unset Server
  Header unset X-Powered-By
  Header always unset X-Pingback
  
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
  
  # HSTS (1 Ano)
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
  
  # Cross-Origin (Permite popup do Google)
  Header always set Cross-Origin-Opener-Policy "same-origin-allow-popups"
  
  # CSP Otimizada (Inclui Google, Bandsintown, Cloudflare)
  # Nota: Usamos "unsafe-inline" e "unsafe-eval" pois são necessários para algumas libs do React em produção
  <If "%{REQUEST_URI} !~ m#^/wp-admin|^/wp-login\.php|^/wp-json#">
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://apis.google.com https://gsi.gstatic.com https://www.googletagmanager.com https://widget.bandsintown.com https://cdn.bandsintown.com https://rest.bandsintown.com https://static.cloudflareinsights.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com https://widget.bandsintown.com https://cdn.bandsintown.com; font-src 'self' https://fonts.gstatic.com https://r2cdn.perplexity.ai data:; img-src 'self' https: data: blob:; connect-src 'self' https://djzeneyer.com https://accounts.google.com https://oauth2.googleapis.com https://www.googleapis.com https://api.bandsintown.com https://rest.bandsintown.com https://widget.bandsintown.com https://cdn.bandsintown.com https://photos.bandsintown.com https://www.googletagmanager.com https://cloudflareinsights.com; frame-src 'self' https://accounts.google.com https://widget.bandsintown.com; object-src 'none'; base-uri 'self';"
  </If>
</IfModule>

# ==============================================================================
# 4. CORS (CRÍTICO PARA API)
# ==============================================================================
<IfModule mod_headers.c>
    # Detecta origem permitida
    SetEnvIf Origin "^https?://(www\.)?(djzeneyer\.com|localhost:5173)$" ALLOWED_ORIGIN=$0
    
    # Se a origem for permitida ou for API, libera
    <If "%{REQUEST_URI} =~ m#^/wp-json/#">
        Header always set Access-Control-Allow-Origin "*"
    </If>
    <Else>
        Header always set Access-Control-Allow-Origin "%{ALLOWED_ORIGIN}e" env=ALLOWED_ORIGIN
    </Else>

    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-WP-Nonce, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
    
    # Preflight OPTIONS
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=204,L]
</IfModule>

# ==============================================================================
# 5. COMPRESSÃO (GZIP/BROTLI)
# ==============================================================================
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json image/svg+xml font/ttf font/otf
</IfModule>

# ==============================================================================
# 6. CACHE CONTROL (Browser)
# ==============================================================================
<IfModule mod_headers.c>
    # NÃO cachear API
    <If "%{REQUEST_URI} =~ m#^/wp-json/#">
        Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    </If>
    
    # Cachear Assets (1 ano)
    <FilesMatch "\.(css|js|mjs|woff|woff2|ttf|otf)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # Cachear Mídia (6 meses)
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
        Header set Cache-Control "public, max-age=15552000"
    </FilesMatch>
</IfModule>

# ==============================================================================
# 7. SEGURANÇA DE ARQUIVOS
# ==============================================================================
<FilesMatch "^(wp-config\.php|\.htaccess|readme\.html|license\.txt|\.git.*|composer\.json|package\.json)$">
  Require all denied
</FilesMatch>

<Files xmlrpc.php>
  Require all denied
</Files>

Options -Indexes

# ==============================================================================
# 8. WORDPRESS DEFAULT
# ==============================================================================
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress