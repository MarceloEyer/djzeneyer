# ==============================================================================
# DJ ZEN EYER - PRODUCTION .htaccess v5.2 (OPTIMIZED)
# ==============================================================================

# ==============================================================================
# 1. LITESPEED CACHE (Mantido do servidor)
# ==============================================================================
# BEGIN LSCACHE
<IfModule LiteSpeed>
RewriteEngine on
CacheLookup on
RewriteRule .* - [E=Cache-Control:no-autoflush]
RewriteRule litespeed/debug/.*\.log$ - [F,L]
RewriteRule \.litespeed_conf\.dat - [F,L]

### marker ASYNC start ###
RewriteCond %{REQUEST_URI} /wp-admin/admin-ajax\.php
RewriteCond %{QUERY_STRING} action=async_litespeed
RewriteRule .* - [E=noabort:1]
### marker ASYNC end ###

### marker MOBILE start ###
RewriteCond %{HTTP_USER_AGENT} Mobile|Android|Silk/|Kindle|BlackBerry|Opera\ Mini|Opera\ Mobi [NC]
RewriteRule .* - [E=Cache-Control:vary=%{ENV:LSCACHE_VARY_VALUE}+ismobile]
### marker MOBILE end ###

### marker NOCACHE COOKIES start ###
RewriteCond %{HTTP_COOKIE} wordpress_logged_in_|woocommerce_cart_hash|woocommerce_items_in_cart|wp_woocommerce_session_|wordpress_logged_in_\*|woocommerce_\*
RewriteRule .* - [E=Cache-Control:no-cache]
### marker NOCACHE COOKIES end ###

### marker NOCACHE PATHS start ###
RewriteCond %{REQUEST_URI} ^/wp-json/|^/feed/|^/comments/feed/|^/api/ [NC]
RewriteRule .* - [E=Cache-Control:no-cache]
### marker NOCACHE PATHS end ###

### marker WEBP start ###
RewriteCond %{HTTP_ACCEPT} image/webp [OR]
RewriteCond %{HTTP_USER_AGENT} iPhone\ OS\ (1[4-9]|[2-9][0-9]) [OR]
RewriteCond %{HTTP_USER_AGENT} Firefox/([6-9][0-9]|[1-9][0-9]{2,})
RewriteRule .* - [E=Cache-Control:vary=%{ENV:LSCACHE_VARY_VALUE}+webp]
### marker WEBP end ###

### marker DROPQS start ###
CacheKeyModify -qs:fbclid
CacheKeyModify -qs:gclid
CacheKeyModify -qs:utm*
CacheKeyModify -qs:_ga
### marker DROPQS end ###

</IfModule>
# END LSCACHE

# BEGIN NON_LSCACHE
<IfModule mod_expires.c>
ExpiresActive on
ExpiresByType application/pdf A31557600
ExpiresByType image/x-icon A31557600
ExpiresByType image/vnd.microsoft.icon A31557600
ExpiresByType image/svg+xml A31557600
ExpiresByType image/jpg A31557600
ExpiresByType image/jpeg A31557600
ExpiresByType image/png A31557600
ExpiresByType image/gif A31557600
ExpiresByType image/webp A31557600
ExpiresByType image/avif A31557600
ExpiresByType video/ogg A31557600
ExpiresByType audio/ogg A31557600
ExpiresByType video/mp4 A31557600
ExpiresByType video/webm A31557600
ExpiresByType text/css A31557600
ExpiresByType text/javascript A31557600
ExpiresByType application/javascript A31557600
ExpiresByType application/x-javascript A31557600
ExpiresByType application/x-font-ttf A31557600
ExpiresByType application/x-font-woff A31557600
ExpiresByType application/font-woff A31557600
ExpiresByType application/font-woff2 A31557600
ExpiresByType application/vnd.ms-fontobject A31557600
ExpiresByType font/ttf A31557600
ExpiresByType font/otf A31557600
ExpiresByType font/woff A31557600
ExpiresByType font/woff2 A31557600
</IfModule>
# END NON_LSCACHE

# ==============================================================================
# 2. MIME TYPES (FIX CRÍTICO PARA REACT)
# ==============================================================================
<IfModule mod_mime.c>
    # JavaScript (CRÍTICO)
    AddType application/javascript .js .mjs
    AddType module .mjs
    
    # CSS
    AddType text/css .css
    
    # JSON
    AddType application/json .json .map
    
    # Fonts
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType font/ttf .ttf
    AddType font/otf .otf
    AddType font/eot .eot
    
    # Images
    AddType image/svg+xml .svg .svgz
    AddType image/webp .webp
    AddType image/avif .avif
    
    # Video
    AddType video/mp4 .mp4
    AddType video/webm .webm
    
    # Other
    AddType application/manifest+json .webmanifest
    AddType application/xml .xml
    AddType text/plain .txt .md
    
    AddDefaultCharset UTF-8
    AddCharset UTF-8 .html .css .js .xml .json .rss .atom
</IfModule>

# ==============================================================================
# 3. SECURITY HEADERS (GOOGLE OAUTH COMPATÍVEL) + BandsInTown
# ==============================================================================
<IfModule mod_headers.c>
    # Remove server info
    Header unset Server
    Header unset X-Powered-By
    Header always unset X-Pingback
    
    # Basic security
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
    
    # Cross-Origin policies
    Header always set Cross-Origin-Opener-Policy "same-origin-allow-popups"
    Header always set Cross-Origin-Resource-Policy "cross-origin"
    
    # CSP (OPTIMIZED FOR GOOGLE OAUTH + BANDSINTOWN + GOOGLE FONTS)
    <If "%{REQUEST_URI} !~ m#^/wp-admin|^/wp-login\.php#">
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://apis.google.com https://gsi.gstatic.com https://www.googletagmanager.com https://widget.bandsintown.com https://cdn.bandsintown.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com https://widget.bandsintown.com https://cdn.bandsintown.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' https: data: blob:; connect-src 'self' https://djzeneyer.com https://accounts.google.com https://oauth2.googleapis.com https://www.googleapis.com https://api.bandsintown.com https://rest.bandsintown.com https://widget.bandsintown.com https://cdn.bandsintown.com https://photos.bandsintown.com https://www.googletagmanager.com; frame-src https://accounts.google.com https://widget.bandsintown.com; object-src 'none'; worker-src 'self' blob:; frame-ancestors 'self'; base-uri 'self'; form-action 'self';"
</If>
</IfModule>

# ==============================================================================
# 4. CORS (Cross-Origin Resource Sharing)
# ==============================================================================
<IfModule mod_headers.c>
    SetEnvIf Origin "^https?://(www\.)?(djzeneyer\.com|localhost:5173|127\.0\.0\.1:5173|localhost:3000)$" ALLOWED_ORIGIN=$0
    Header always set Access-Control-Allow-Origin "%{ALLOWED_ORIGIN}e" env=ALLOWED_ORIGIN
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-WP-Nonce, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Vary "Origin"
    
    # Handle OPTIONS preflight
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=204,L]
</IfModule>

# ==============================================================================
# 5. COMPRESSION
# ==============================================================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
    AddOutputFilterByType DEFLATE application/javascript application/x-javascript application/json
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType DEFLATE image/svg+xml image/x-icon
    AddOutputFilterByType DEFLATE font/ttf font/otf font/woff font/woff2
    
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|zip|gz|bz2|rar|7z)$ no-gzip
</IfModule>

<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json application/xml
</IfModule>

# ==============================================================================
# 6. BROWSER CACHING
# ==============================================================================
<IfModule mod_headers.c>
    <FilesMatch "\.(css|js|mjs)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
        Header set Cache-Control "public, max-age=15552000"
    </FilesMatch>
    
    <FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
</IfModule>

# ==============================================================================
# 7. SECURITY
# ==============================================================================
<FilesMatch "^(wp-config\.php|\.htaccess|readme\.html|license\.txt|\.git.*|\.env.*|composer\.json|package\.json)$">
    Require all denied
</FilesMatch>

<Files xmlrpc.php>
    Require all denied
</Files>

Options -Indexes -MultiViews

<Directory wp-content/uploads>
    <Files *.php>
        Require all denied
    </Files>
</Directory>

# ==============================================================================
# 8. WORDPRESS REWRITE
# ==============================================================================
# BEGIN WordPress
# As diretrizes (linhas) entre "BEGIN WordPress" e "END WordPress" são
# geradas dinamicamente e só devem ser modificadas através de filtros do WordPress.
# Quaisquer alterações nas diretivas entre esses marcadores serão sobrescritas.
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>

# END WordPress

# ==============================================================================
# 9. KEEP-ALIVE
# ==============================================================================
<IfModule mod_headers.c>
    Header set Connection keep-alive
</IfModule>

# ==============================================================================
# 10. ETAGS
# ==============================================================================
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None