name: Production Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: 20
  SSH_HOST: 147.79.84.222
  SSH_PORT: 65002
  SSH_USER: u790739895
  REMOTE_ROOT: /home/u790739895/domains/djzeneyer.com/public_html
  THEME_NAME: zentheme
  SITE_URL: https://djzeneyer.com

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-24.04
    outputs:
      commit_hash: ${{ steps.commit.outputs.hash }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”– Commit hash
        id: commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ğŸ”¨ Build produÃ§Ã£o
        env:
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
        run: npm run build

      - name: ğŸ•µï¸ Verificar estrutura do build
        run: |
          echo "Listando conteÃºdo de dist/..."
          ls -R dist/
          if [ -f "dist/.vite/manifest.json" ]; then
            echo "âœ… SUCESSO: manifest.json foi encontrado!"
          else
            echo "âŒ FALHA: dist/.vite/manifest.json NÃƒO foi encontrado!"
            exit 1
          fi

      # =======================================================
      # CORREÃ‡ÃƒO: Usar dois artefatos E o parÃ¢metro CORRETO
      # =======================================================
      - name: ğŸ“¤ Upload artifact (dist)
        uses: actions/upload-artifact@v4
        with:
          name: build-dist-${{ steps.commit.outputs.hash }}
          path: dist/ # <-- APENAS a pasta dist
          # âœ… ESTA Ã‰ A CORREÃ‡ÃƒO: include-hidden-files
          include-hidden-files: true 
          retention-days: 7

      - name: ğŸ“¤ Upload artifact (theme files)
        uses: actions/upload-artifact@v4
        with:
          name: build-theme-${{ steps.commit.outputs.hash }}
          path: |
            functions.php
            style.css
            screenshot.png
            header.php
            footer.php
            index.php
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy
    needs: build
    runs-on: ubuntu-24.04
    environment:
      name: production
      url: ${{ env.SITE_URL }}

    steps:
      - name: ğŸ“¥ Checkout (para verificar estrutura)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            inc
            plugins
            public
          sparse-checkout-cone-mode: false

      # =======================================================
      # CORREÃ‡ÃƒO: Baixar os DOIS artefatos separadamente
      # =======================================================
      - name: ğŸ“¥ Download build artifact (dist)
        uses: actions/download-artifact@v4
        with:
          name: build-dist-${{ needs.build.outputs.commit_hash }}
          path: ./dist # Baixa DIRETAMENTE para uma pasta 'dist' local

      - name: ğŸ“¥ Download build artifact (theme files)
        uses: actions/download-artifact@v4
        with:
          name: build-theme-${{ needs.build.outputs.commit_hash }}
          path: ./ # Baixa os arquivos PHP na raiz (./)

      - name: ğŸ•µï¸ Verificar artefato baixado
        run: |
          echo "Listando arquivos baixados (deve incluir 'dist/'):"
          ls -R ./
          if [ -f "dist/.vite/manifest.json" ]; then
            echo "âœ… SUCESSO: O artefato baixado contÃ©m o manifest.json!"
          else
            echo "âŒ FALHA: O artefato baixado NÃƒO contÃ©m o manifest.json!"
            exit 1
          fi

      - name: ğŸ” Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary
          name: id_rsa

      - name: ğŸ§ª Testar SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âœ… SSH OK"
            pwd && whoami

      - name: ğŸ“¦ Backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/deploy_${TIMESTAMP}"
            THEME_PATH="${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}"
            
            echo "ğŸ“¦ Criando backup..."
            mkdir -p "${BACKUP_DIR}"
            
            if [ -d "${THEME_PATH}" ]; then
              tar -czf "${BACKUP_DIR}/theme_backup.tar.gz" -C "${THEME_PATH}" . 2>/dev/null || true
              echo "âœ… Backup criado"
            fi
            
            mkdir -p "${THEME_PATH}"/dist
            mkdir -p "${{ env.REMOTE_ROOT }}/wp-content/plugins"
            
            cd "$HOME/backups" && ls -t | tail -n +6 | xargs -r rm -rf 2>/dev/null || true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOY: dist/ (SEMPRE EXISTE)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸš€ Deploy dist/
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: dist/ 
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/dist/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOY: inc/ (SE EXISTIR)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“š Deploy inc/ (se existir)
        if: hashFiles('inc/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: inc/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/inc/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOY: PHP files (functions.php, style.css, etc)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“ Deploy PHP files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "functions.php,style.css,screenshot.png,header.php,footer.php,index.php"
          target: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/
          strip_components: 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOY: plugins/ (SE EXISTIR)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”Œ Deploy plugins/ (se existir)
        if: hashFiles('plugins/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: plugins/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/plugins/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOY: public/ (SE EXISTIR - apenas arquivos seguros)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“„ Deploy public/ (se existir)
        if: hashFiles('public/**') != ''
        run: |
          # Verificar quais arquivos existem
          SAFE_FILES=(robots.txt ai-bots.txt favicon.ico favicon.svg apple-touch-icon.png site.webmanifest)
          
          mkdir -p temp_public
          
          for file in "${SAFE_FILES[@]}"; do
            if [ -f "public/$file" ]; then
              cp "public/$file" temp_public/
              echo "âœ“ $file"
            fi
          done
          
          # SÃ³ fazer rsync se houver arquivos
          if [ "$(ls -A temp_public)" ]; then
            echo "Enviando arquivos pÃºblicos..."
          else
            echo "Nenhum arquivo pÃºblico para enviar"
            exit 0
          fi

      - name: ğŸ“„ Rsync public assets
        if: hashFiles('public/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avz
          path: temp_public/
          remote_path: ${{ env.REMOTE_ROOT }}/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERIFICAÃ‡ÃƒO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âœ… Verificar
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ” VERIFICANDO DEPLOY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            THEME_PATH="${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}"
            
            echo "ğŸ“ Tema: $THEME_PATH"
            if [ -d "$THEME_PATH" ]; then
              echo "âœ… Tema existe"
            else
              echo "âŒ Tema nÃ£o encontrado!"
              exit 1
            fi
            
            echo ""
            echo "ğŸ“ dist/:"
            if [ ! -d "$THEME_PATH/dist" ]; then
              echo "âŒ dist/ nÃ£o encontrado!"
              exit 1
            fi

            echo "--- Verificando manifest.json (O MAIS IMPORTANTE) ---"
            if [ -f "$THEME_PATH/dist/.vite/manifest.json" ]; then
              echo "âœ… SUCESSO! manifest.json estÃ¡ no servidor!"
              DIST_SIZE=$(du -sh "$THEME_PATH/dist" | cut -f1)
              FILE_COUNT=$(find "$THEME_PATH/dist" -type f | wc -l)
              echo "âœ… $DIST_SIZE ($FILE_COUNT arquivos)"
            else
              echo "âŒ FALHA! manifest.json NÃƒO estÃ¡ no servidor!"
              echo "Listando conteÃºdo de dist/ para debug:"
              ls -R "$THEME_PATH/dist"
              exit 1
            fi
            
            echo ""
            echo "ğŸ“„ Arquivos PHP:"
            [ -f "$THEME_PATH/functions.php" ] && echo "âœ… functions.php" || echo "âš ï¸ functions.php"
            [ -f "$THEME_PATH/style.css" ] && echo "âœ… style.css" || echo "âš ï¸ style.css"
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… VERIFICAÃ‡ÃƒO OK"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
