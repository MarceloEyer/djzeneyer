# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ DEPLOY SIMPLES E FUNCIONAL - DJ ZEN EYER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Deploy automÃ¡tico para Hostinger via rsync/SSH
# React (Vite) â†’ WordPress Headless Theme
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸš€ Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. PREPARAR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. BUILD
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”¨ Build produÃ§Ã£o
        run: npm run build
        env:
          NODE_ENV: production
          VITE_WP_SITE_URL: ${{ secrets.VITE_WP_SITE_URL }}
          VITE_WP_REST_URL: ${{ secrets.VITE_WP_REST_URL }}
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}

      - name: âœ… Verificar build
        run: |
          echo "ğŸ“¦ Verificando arquivos de build..."
          ls -lh dist/ || { echo "âŒ Pasta dist/ nÃ£o encontrada!"; exit 1; }
          
          echo ""
          echo "ğŸ“‚ Estrutura do build:"
          find dist/ -type f | head -20
          
          echo ""
          echo "âœ… Build verificado com sucesso!"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. PREPARAR SSH
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”‘ Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: ğŸ§ª Testar conexÃ£o SSH
        run: |
          echo "ğŸ”Œ Testando conexÃ£o com ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}..."
          ssh -o ConnectTimeout=10 "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "echo 'âœ… ConexÃ£o SSH OK!'"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. PREPARAR CAMINHOS REMOTOS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“ Criar estrutura de diretÃ³rios
        run: |
          ssh "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash -s <<'ENDSSH'
            # Garantir que os diretÃ³rios existam
            mkdir -p "${{ secrets.SSH_THEME_PATH }}/dist"
            mkdir -p "${{ secrets.SSH_THEME_PATH }}/inc"
            mkdir -p "${{ secrets.SSH_PLUGINS_PATH }}"
            mkdir -p "${{ secrets.SSH_PUBLIC_PATH }}"
            
            echo "âœ… Estrutura de diretÃ³rios criada"
          ENDSSH

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. DEPLOY (3 PASSOS PRINCIPAIS)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      # 5.1 â†’ Deploy DIST (Frontend React/Vite)
      - name: ğŸš€ Deploy dist/
        run: |
          echo "ğŸ“¤ Enviando dist/ para ${{ secrets.SSH_THEME_PATH }}/dist/..."
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./dist/ \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/dist/"
          echo "âœ… dist/ enviado com sucesso!"

      # 5.2 â†’ Deploy INC (Functions PHP do theme)
      - name: ğŸš€ Deploy inc/
        run: |
          echo "ğŸ“¤ Enviando inc/ para ${{ secrets.SSH_THEME_PATH }}/inc/..."
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./inc/ \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/inc/"
          echo "âœ… inc/ enviado com sucesso!"

      # 5.3 â†’ Deploy arquivos PHP raiz do theme
      - name: ğŸš€ Deploy *.php (raiz do theme)
        run: |
          echo "ğŸ“¤ Enviando arquivos PHP para ${{ secrets.SSH_THEME_PATH }}/..."
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            --include='*.php' \
            --include='style.css' \
            --include='screenshot.png' \
            --exclude='*' \
            ./ \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/"
          echo "âœ… Arquivos PHP enviados com sucesso!"

      # 5.4 â†’ Deploy plugins customizados
      - name: ğŸ”Œ Deploy plugins/
        run: |
          if [ -d "plugins" ]; then
            echo "ğŸ“¤ Enviando plugins para ${{ secrets.SSH_PLUGINS_PATH }}/..."
            
            for plugin_dir in plugins/*/; do
              if [ -d "$plugin_dir" ]; then
                plugin_name=$(basename "$plugin_dir")
                echo "  â†’ Enviando plugin: $plugin_name"
                
                # Sync cada plugin para seu diretÃ³rio correspondente
                rsync -avz --delete \
                  -e "ssh -o StrictHostKeyChecking=no" \
                  "$plugin_dir" \
                  "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PLUGINS_PATH }}/"
              fi
            done
            
            echo "âœ… Plugins enviados com sucesso!"
          else
            echo "â„¹ï¸  Pasta plugins/ nÃ£o encontrada. Pulando..."
          fi

      # 5.5 â†’ Deploy arquivos pÃºblicos (opcional)
      - name: ğŸ“„ Deploy public/
        run: |
          if [ -d "public" ]; then
            echo "ğŸ“¤ Enviando public/ para ${{ secrets.SSH_PUBLIC_PATH }}/..."
            rsync -avz \
              -e "ssh -o StrictHostKeyChecking=no" \
              ./public/ \
              "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PUBLIC_PATH }}/"
            echo "âœ… public/ enviado com sucesso!"
          else
            echo "â„¹ï¸  Pasta public/ nÃ£o encontrada. Pulando..."
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. LIMPAR CACHE WORDPRESS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¹ Limpar cache WordPress
        run: |
          echo "ğŸ§¹ Limpando caches..."
          ssh "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash -s <<'ENDSSH'
            # Limpar cache de objetos WordPress
            if command -v wp &> /dev/null; then
              cd "${{ secrets.SSH_WP_PATH }}" || exit 1
              wp cache flush --allow-root 2>/dev/null || echo "â„¹ï¸  WP-CLI nÃ£o disponÃ­vel"
            fi
            
            # Limpar cache de opcache PHP
            find "${{ secrets.SSH_THEME_PATH }}" -name "*.php" -exec touch {} + 2>/dev/null
            
            echo "âœ… Cache limpo!"
          ENDSSH

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. VERIFICAR PERMISSÃ•ES
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”’ Verificar permissÃµes
        run: |
          echo "ğŸ”’ Ajustando permissÃµes..."
          ssh "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash -s <<'ENDSSH'
            # Ajustar permissÃµes do theme
            find "${{ secrets.SSH_THEME_PATH }}" -type d -exec chmod 755 {} \;
            find "${{ secrets.SSH_THEME_PATH }}" -type f -exec chmod 644 {} \;
            
            # Ajustar permissÃµes dos plugins
            if [ -d "${{ secrets.SSH_PLUGINS_PATH }}" ]; then
              find "${{ secrets.SSH_PLUGINS_PATH }}" -type d -exec chmod 755 {} \;
              find "${{ secrets.SSH_PLUGINS_PATH }}" -type f -exec chmod 644 {} \;
            fi
            
            echo "âœ… PermissÃµes ajustadas!"
          ENDSSH

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. RELATÃ“RIO
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š RelatÃ³rio final
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo ""
          echo "ğŸŒ Site: ${{ secrets.SITE_URL }}"
          echo "ğŸ“¦ Commit: $(git rev-parse --short HEAD)"
          echo "â° HorÃ¡rio: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ‰ Seu site estÃ¡ no ar!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # HEALTH CHECK (Opcional mas recomendado)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      - name: ğŸ” Testar site
        run: |
          echo "ğŸ” Testando ${{ secrets.SITE_URL }}..."
          
          for i in {1..3}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 20 ${{ secrets.SITE_URL }})
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Site OK (HTTP $HTTP_CODE)"
              exit 0
            else
              echo "âš ï¸  Tentativa $i/3: HTTP $HTTP_CODE"
              sleep 5
            fi
          done
          
          echo "âŒ Site nÃ£o estÃ¡ acessÃ­vel"
          exit 1

      - name: ğŸ“Š Resultado
        if: success()
        run: |
          echo ""
          echo "ğŸ‰ TUDO FUNCIONANDO!"
          echo "ğŸŒ ${{ secrets.SITE_URL }}"
