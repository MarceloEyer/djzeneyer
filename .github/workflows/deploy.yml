name: Production Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: 20
  SSH_HOST: 147.79.84.222
  SSH_PORT: 65002
  SSH_USER: u790739895
  REMOTE_ROOT: /home/u790739895/domains/djzeneyer.com/public_html
  THEME_NAME: zentheme
  SITE_URL: https://djzeneyer.com

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-24.04
    outputs:
      commit_hash: ${{ steps.commit.outputs.hash }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”– Commit hash
        id: commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ğŸ”¨ Build produÃ§Ã£o
        env:
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
        run: npm run build

      - name: âœ… Validar build
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ dist/ nÃ£o encontrado!"
            exit 1
          fi
          echo "âœ… Build OK - $(du -sh dist/ | cut -f1)"

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ steps.commit.outputs.hash }}
          path: |
            dist/
            inc/
            plugins/
            functions.php
            style.css
            screenshot.png
            header.php
            footer.php
            index.php
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: DEPLOY (ESTRUTURA CORRETA)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy
    needs: build
    runs-on: ubuntu-24.04
    environment:
      name: production
      url: ${{ env.SITE_URL }}

    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ needs.build.outputs.commit_hash }}
          path: ./

      - name: ğŸ” Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary
          name: id_rsa

      - name: ğŸ§ª Testar SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âœ… SSH OK"
            pwd && whoami

      - name: ğŸ“¦ Backup no servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/deploy_${TIMESTAMP}"
            THEME_PATH="${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}"
            
            echo "ğŸ“¦ Criando backup..."
            mkdir -p "${BACKUP_DIR}"
            
            if [ -d "${THEME_PATH}" ]; then
              tar -czf "${BACKUP_DIR}/theme_backup.tar.gz" -C "${THEME_PATH}" . 2>/dev/null || true
              echo "âœ… Backup criado"
            fi
            
            # Criar estrutura
            mkdir -p "${THEME_PATH}"/{dist,inc,assets}
            mkdir -p "${{ env.REMOTE_ROOT }}/wp-content/plugins"
            
            # Limpar backups antigos
            cd "$HOME/backups" && ls -t | tail -n +6 | xargs -r rm -rf 2>/dev/null || true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOY ORGANIZADO POR DESTINO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      # 1. TEMA: dist/ (React build)
      - name: ğŸš€ Deploy dist/ â†’ tema/dist/
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: dist/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/dist/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 2. TEMA: inc/ (PHP helpers)
      - name: ğŸ“š Deploy inc/ â†’ tema/inc/
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: inc/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/inc/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3. TEMA: Arquivos PHP root (functions.php, style.css, etc)
      - name: ğŸ“ Deploy PHP files â†’ tema/
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "functions.php,style.css,screenshot.png,header.php,footer.php,index.php"
          target: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/
          strip_components: 0

      # 4. PLUGINS: plugins/ â†’ wp-content/plugins/
      - name: ğŸ”Œ Deploy plugins/ â†’ wp-content/plugins/
        if: hashFiles('plugins/**') != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Receber arquivos via rsync (precisa estar no runner)
            echo "Preparando diretÃ³rio de plugins..."
            mkdir -p "${{ env.REMOTE_ROOT }}/wp-content/plugins"

      - name: ğŸ”Œ Sync plugins/
        if: hashFiles('plugins/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete
          path: plugins/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/plugins/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 5. PUBLIC: public/ â†’ root (robots.txt, favicon, etc)
      - name: ğŸ“„ Deploy public/ â†’ root
        if: hashFiles('public/**') != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd "${{ env.REMOTE_ROOT }}"
            
            # Apenas arquivos seguros (nÃ£o sobrescreve WordPress)
            SAFE_FILES=(
              "robots.txt"
              "ai-bots.txt"
              "favicon.ico"
              "favicon.svg"
              "apple-touch-icon.png"
              "site.webmanifest"
              "browserconfig.xml"
            )
            
            echo "Preparando para receber assets pÃºblicos..."

      - name: ğŸ“„ Sync public assets
        if: hashFiles('public/**') != ''
        run: |
          # Criar arquivo temporÃ¡rio com lista de arquivos seguros
          mkdir -p temp_public
          cd public
          
          for file in robots.txt ai-bots.txt favicon.ico favicon.svg apple-touch-icon.png site.webmanifest browserconfig.xml; do
            if [ -f "$file" ]; then
              cp "$file" ../temp_public/
            fi
          done
          
          cd ..
          
          if [ "$(ls -A temp_public)" ]; then
            echo "Enviando assets pÃºblicos..."
          fi

      - name: ğŸ“„ Upload public assets
        if: hashFiles('public/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avz
          path: public/
          remote_path: ${{ env.REMOTE_ROOT }}/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # VERIFICAÃ‡ÃƒO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âœ… Verificar estrutura
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ” VERIFICANDO ESTRUTURA"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            THEME_PATH="${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}"
            ROOT_PATH="${{ env.REMOTE_ROOT }}"
            
            # Verificar tema
            echo "ğŸ“ TEMA (${{ env.THEME_NAME }}):"
            if [ -d "$THEME_PATH" ]; then
              echo "  âœ… $THEME_PATH"
              ls -lh "$THEME_PATH" | grep -E '^d|\.php$|\.css$'
            else
              echo "  âŒ Tema nÃ£o encontrado!"
              exit 1
            fi
            
            echo ""
            echo "ğŸ“ dist/:"
            if [ -d "$THEME_PATH/dist" ]; then
              DIST_SIZE=$(du -sh "$THEME_PATH/dist" | cut -f1)
              FILE_COUNT=$(find "$THEME_PATH/dist" -type f | wc -l)
              echo "  âœ… $DIST_SIZE ($FILE_COUNT arquivos)"
              find "$THEME_PATH/dist" -type f -name "*.js" | head -3
            else
              echo "  âŒ dist/ nÃ£o encontrado!"
              exit 1
            fi
            
            echo ""
            echo "ğŸ“ inc/:"
            if [ -d "$THEME_PATH/inc" ]; then
              INC_COUNT=$(find "$THEME_PATH/inc" -name "*.php" | wc -l)
              echo "  âœ… $INC_COUNT arquivos PHP"
            else
              echo "  âš ï¸  inc/ nÃ£o encontrado (pode ser opcional)"
            fi
            
            echo ""
            echo "ğŸ“„ Arquivos do tema:"
            [ -f "$THEME_PATH/functions.php" ] && echo "  âœ… functions.php" || echo "  âŒ functions.php"
            [ -f "$THEME_PATH/style.css" ] && echo "  âœ… style.css" || echo "  âŒ style.css"
            [ -f "$THEME_PATH/screenshot.png" ] && echo "  âœ… screenshot.png" || echo "  â„¹ï¸  screenshot.png"
            
            echo ""
            echo "ğŸ”Œ PLUGINS:"
            if [ -d "$ROOT_PATH/wp-content/plugins" ]; then
              PLUGIN_COUNT=$(find "$ROOT_PATH/wp-content/plugins" -mindepth 1 -maxdepth 1 -type d | wc -l)
              echo "  âœ… $PLUGIN_COUNT plugins instalados"
            fi
            
            echo ""
            echo "ğŸ“„ ROOT (public_html/):"
            [ -f "$ROOT_PATH/robots.txt" ] && echo "  âœ… robots.txt" || echo "  â„¹ï¸  robots.txt"
            [ -f "$ROOT_PATH/favicon.ico" ] && echo "  âœ… favicon.ico" || echo "  â„¹ï¸  favicon.ico"
            [ -f "$ROOT_PATH/wp-config.php" ] && echo "  âœ… wp-config.php (preservado)" || echo "  âŒ wp-config.php"
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… ESTRUTURA CORRETA!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # HEALTH CHECK
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ¥ Health check
        run: |
          echo "ğŸ” Testando ${{ env.SITE_URL }}..."
          sleep 5
          
          for i in {1..3}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 20 ${{ env.SITE_URL }})
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Site OK (HTTP $HTTP_CODE)"
              exit 0
            else
              echo "âš ï¸  Tentativa $i/3: HTTP $HTTP_CODE"
              sleep 5
            fi
          done
          
          echo "âŒ Site nÃ£o acessÃ­vel"
          exit 1

      - name: ğŸ“Š Resumo
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
            echo ""
            echo "ğŸŒ Site: ${{ env.SITE_URL }}"
            echo "ğŸ“¦ Commit: ${{ needs.build.outputs.commit_hash }}"
            echo "ğŸ“ Estrutura:"
            echo "   dist/      â†’ tema/dist/"
            echo "   inc/       â†’ tema/inc/"
            echo "   *.php      â†’ tema/"
            echo "   plugins/   â†’ wp-content/plugins/"
            echo "   public/    â†’ root/"
          else
            echo "âŒ DEPLOY FALHOU"
            echo "Verifique os logs acima"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
