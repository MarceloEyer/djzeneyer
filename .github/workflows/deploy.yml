name: üöÄ Deploy WordPress Headless Theme

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  WP_THEME_SLUG: 'zentheme'
  WP_PLUGINS_DIR: 'plugins'
  WP_INC_DIR: 'inc'

jobs:
  build:
    name: üèóÔ∏è Build Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: |
          echo "üì¶ Installing npm dependencies..."
          npm ci
      
      - name: üî® Build with Vite
        run: |
          echo "üèóÔ∏è Building production bundle..."
          npm run build
          echo "‚úÖ Build completed"
      
      - name: ‚úÖ Validate build output
        run: |
          echo "Checking dist folder..."
          test -d dist || exit 1
          test -f dist/manifest.json || exit 1
          echo "‚úÖ Build validation passed"
      
      - name: üì¶ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: wordpress-theme-build
          path: |
            dist/
            inc/
            plugins/
            *.php
            style.css
            public/
          retention-days: 1

  deploy:
    name: üöÄ Deploy para Produ√ß√£o
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì• Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: wordpress-theme-build
      
      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: üì¶ Deploy WordPress Theme
        run: |
          echo "üöÄ Starting deploy..."
          SSH_CMD="ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
          
          # Create backup
          echo "üíæ Creating backup..."
          $SSH_CMD "mkdir -p ~/backups && tar -czf ~/backups/zentheme-backup-$(date +%Y%m%d-%H%M%S).tar.gz ${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes/${{ env.WP_THEME_SLUG }} 2>/dev/null || true"
          
          # Deploy React dist
          echo "üì¶ Deploying React build..."
          scp -P ${{ secrets.SSH_PORT }} -r dist/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes/${{ env.WP_THEME_SLUG }}/dist/ || true
          
          # Deploy PHP files
          echo "üìù Deploying PHP files..."
          find . -maxdepth 1 -name '*.php' -exec scp -P ${{ secrets.SSH_PORT }} {} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes/${{ env.WP_THEME_SLUG }}/ \;
          scp -P ${{ secrets.SSH_PORT }} style.css ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes/${{ env.WP_THEME_SLUG }}/
          
          # Deploy inc folder
          echo "üìÇ Deploying inc folder..."
          scp -P ${{ secrets.SSH_PORT }} -r inc/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes/${{ env.WP_THEME_SLUG }}/inc/ || true
          
          # Deploy plugins
          echo "üîå Deploying plugins..."
          if [ -d "plugins" ]; then
            scp -P ${{ secrets.SSH_PORT }} -r plugins/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_WP_ROOT }}/wp-content/plugins/ || true
          fi
          
          # Deploy public files (robots.txt, favicon.ico)
          echo "üìÑ Deploying public files..."
          if [ -f "public/robots.txt" ]; then
            scp -P ${{ secrets.SSH_PORT }} public/robots.txt ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_WP_ROOT }}/robots.txt
          fi
          if [ -f "public/favicon.ico" ]; then
            scp -P ${{ secrets.SSH_PORT }} public/favicon.ico ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_WP_ROOT }}/favicon.ico
          fi
          
          # Verify deployment
          echo "üîç Verifying deployment..."
          $SSH_CMD "ls -lah ${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes/${{ env.WP_THEME_SLUG }}/dist/ | head -20"
          echo "‚úÖ Deploy completed"

  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10
    
    steps:
      - name: üåê Check site accessibility
        run: |
          echo "Checking website..."
          curl -s -o /dev/null -w "%{http_code}" https://djzeneyer.com || echo "Site check failed"
      
      - name: üîå Check WordPress REST API
        run: |
          echo "Checking WordPress REST API..."
          curl -s https://djzeneyer.com/wp-json/ | jq . || echo "REST API check failed"
      
      - name: üéØ Check custom REST endpoint
        run: |
          echo "Checking custom REST endpoint..."
          curl -s https://djzeneyer.com/wp-json/djz/v1/config | jq . || echo "Custom endpoint check failed"
      
      - name: üìÑ Check robots.txt
        run: |
          echo "Checking robots.txt for SEO..."
          curl -s https://djzeneyer.com/robots.txt | grep -q "User-agent" && echo "‚úÖ robots.txt OK" || echo "‚ö†Ô∏è robots.txt issue"
      
      - name: ‚úÖ Health check completed
        run: echo "üéâ All health checks passed!"
