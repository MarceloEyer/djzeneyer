name: Build and Deploy to Hostinger

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build
        env:
          VITE_WP_SITE_URL: https://djzeneyer.com
          VITE_WP_REST_URL: https://djzeneyer.com/wp-json/
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}

      - name: Upload build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-build
          path: ./dist

      - name: Install lftp (for robust SFTP/FTPS with retries)
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy dist (safe clean)
        env:
          FTP_HOST: ${{ secrets.FTP_SERVER }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.FTP_PORT || '22' }}
          REMOTE_DIR: /wp-content/themes/zentheme/dist
        run: |
          set -e
          RETRY_COUNT=3
          for i in $(seq 1 $RETRY_COUNT); do
            echo "Deploy attempt #$i"
            lftp -u "$FTP_USER","$FTP_PASS" -p $FTP_PORT sftp://$FTP_HOST -e "
              set -e;
              mkdir -p $REMOTE_DIR;
              mirror -R --delete --parallel=5 ./dist $REMOTE_DIR;
              ls -la $REMOTE_DIR;
              bye
            " && break || (echo "Attempt $i failed, retrying..." && sleep 5)
          done

      - name: Deploy theme files (no destructive clean)
        env:
          FTP_HOST: ${{ secrets.FTP_SERVER }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.FTP_PORT || '22' }}
          REMOTE_THEME_DIR: /wp-content/themes/zentheme
        run: |
          set -e
          lftp -u "$FTP_USER","$FTP_PASS" -p $FTP_PORT sftp://$FTP_HOST -e "
            set -e;
            mirror -R --parallel=3 --only-newer \
              --exclude-glob dist \
              --exclude-glob node_modules \
              --exclude-glob .git \
              --exclude-glob .github \
              ./ $REMOTE_THEME_DIR;
            ls -la $REMOTE_THEME_DIR;
            bye
          "

      - name: Purge LiteSpeed Cache via HTTP (optional, runs only if secrets set)
        env:
          LSCACHE_PURGE_URL: ${{ secrets.LSCACHE_PURGE_URL }}
          LSCACHE_PURGE_TOKEN: ${{ secrets.LSCACHE_PURGE_TOKEN }}
        run: |
          if [ -z "${LSCACHE_PURGE_URL}" ] || [ -z "${LSCACHE_PURGE_TOKEN}" ]; then
            echo "LSCache purge secrets not set, skipping purge."
            exit 0
          fi
          echo "Purging LiteSpeed cache..."
          curl -X PURGE "${LSCACHE_PURGE_URL}" \
            -H "Authorization: Bearer ${LSCACHE_PURGE_TOKEN}" \
            --fail --show-error

      - name: Verify deployed assets exist
        env:
          FTP_HOST: ${{ secrets.FTP_SERVER }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.FTP_PORT || '22' }}
          REMOTE_DIR: /wp-content/themes/zentheme/dist
        run: |
          lftp -u "$FTP_USER","$FTP_PASS" -p $FTP_PORT sftp://$FTP_HOST -e "
            set -e;
            cls -1 $REMOTE_DIR | head -n 20;
            bye
          "
