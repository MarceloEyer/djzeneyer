# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ DJ ZEN EYER - PREMIUM PRODUCTION DEPLOY
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 
# DESCRIรรO: Deploy automรกtico otimizado para WordPress Headless
# TRIGGER: Push na branch 'main' ou manual (workflow_dispatch)
# FEATURES: Build Local de Dependรชncias, Backup, Cache Purge, Health Check
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

name: ๐ Production Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build (use existing artifact)'
        required: false
        type: boolean
        default: false

concurrency:
  group: production-deploy
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: 20
  SSH_HOST: 147.79.84.222
  SSH_PORT: 65002
  SSH_USER: u790739895
  REMOTE_ROOT: /home/u790739895/domains/djzeneyer.com/public_html
  THEME_NAME: zentheme
  SITE_URL: https://djzeneyer.com

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# JOB 1: BUILD (Frontend + Plugin Dependencies)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

jobs:
  build:
    name: ๐๏ธ Build
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    if: ${{ !inputs.skip_build }}
    
    outputs:
      commit_hash: ${{ steps.commit.outputs.hash }}
      build_timestamp: ${{ steps.timestamp.outputs.value }}
      build_status: ${{ job.status }}
    
    steps:
      - name: ๐ฅ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ๐ Generate metadata
        id: commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: โฐ Generate timestamp
        id: timestamp
        run: echo "value=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: ๐ง Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # --- FRONTEND BUILD ---
      - name: ๐ฆ Install Frontend dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ๐จ Build production (React)
        env:
          NODE_ENV: production
          VITE_WP_SITE_URL: ${{ env.SITE_URL }}
          VITE_WP_REST_URL: ${{ env.SITE_URL }}/wp-json/
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
        run: npm run build

      - name: โ Validate build
        run: |
          echo "๐ Validating build output..."
          if [ ! -d dist ]; then echo "โ dist/ directory not found"; exit 1; fi
          if [ ! -f dist/index.html ]; then echo "โ dist/index.html not found"; exit 1; fi
          if [ -f "dist/.vite/manifest.json" ]; then
            echo "โ manifest.json found"
          else
            echo "โ dist/.vite/manifest.json NOT found!"
            exit 1
          fi
          echo "โ Build validation passed"

      # --- PLUGIN DEPENDENCIES BUILD (MOVED HERE) ---
      - name: ๐จ Build Plugin Dependencies
        run: |
          echo "๐ฆ Installing composer dependencies for plugins..."
          # Iterate over directories in plugins/
          if [ -d "plugins" ]; then
            for dir in plugins/*/; do
              if [ -f "$dir/composer.json" ]; then
                echo "  โ Installing dependencies for $(basename "$dir")"
                cd "$dir"
                # Install dependencies locally on the runner
                composer install --no-dev --optimize-autoloader --ignore-platform-reqs --no-interaction
                # Remove dev files to keep deploy light
                rm -rf tests/ .git/ .github/
                cd - > /dev/null
              fi
            done
          else
             echo "โ๏ธ Plugins directory not found in repo, skipping dependency build."
          fi

      # --- ARTIFACT UPLOADS ---
      - name: ๐ค Upload build artifact (dist)
        uses: actions/upload-artifact@v4
        with:
          name: build-dist-${{ steps.commit.outputs.hash }}
          path: dist/
          include-hidden-files: true
          retention-days: 7
          compression-level: 6

      - name: ๐ค Upload build artifact (theme files)
        uses: actions/upload-artifact@v4
        with:
          name: build-theme-${{ steps.commit.outputs.hash }}
          path: |
            functions.php
            style.css
            screenshot.png
            header.php
            footer.php
            index.php
          retention-days: 7

      - name: ๐ค Upload build artifact (plugins)
        uses: actions/upload-artifact@v4
        with:
          name: build-plugins-${{ steps.commit.outputs.hash }}
          path: plugins/
          retention-days: 7

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# JOB 2: DEPLOY
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  deploy:
    name: ๐ Deploy
    needs: build
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    if: |
      always() && 
      (needs.build.result == 'success' || inputs.skip_build)
    
    environment:
      name: production
      url: ${{ env.SITE_URL }}
    
    steps:
      - name: ๐ฅ Checkout (sparse)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            inc
            public
          sparse-checkout-cone-mode: false

      # --- DOWNLOAD ARTIFACTS ---
      - name: ๐ฅ Download build artifact (dist)
        if: ${{ !inputs.skip_build }}
        uses: actions/download-artifact@v4
        with:
          name: build-dist-${{ needs.build.outputs.commit_hash }}
          path: ./dist

      - name: ๐ฅ Download build artifact (theme files)
        if: ${{ !inputs.skip_build }}
        uses: actions/download-artifact@v4
        with:
          name: build-theme-${{ needs.build.outputs.commit_hash }}
          path: ./

      - name: ๐ฅ Download build artifact (plugins)
        if: ${{ !inputs.skip_build }}
        uses: actions/download-artifact@v4
        with:
          name: build-plugins-${{ needs.build.outputs.commit_hash }}
          path: ./plugins

      # --- SSH SETUP ---
      - name: ๐ Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary
          name: id_rsa

      # --- BACKUP ---
      - name: ๐ฆ Create backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/deploy_${TIMESTAMP}"
            THEME_PATH="${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}"
            
            echo "๐ฆ Creating backup: ${BACKUP_DIR}"
            mkdir -p "${BACKUP_DIR}"
            
            # Backup theme
            if [ -d "${THEME_PATH}" ]; then
              echo "  โ Backing up theme..."
              tar -czf "${BACKUP_DIR}/theme_backup.tar.gz" -C "${THEME_PATH}" . 2>/dev/null || true
            fi
            
            # Ensure directories exist
            mkdir -p "${THEME_PATH}/dist"
            mkdir -p "${{ env.REMOTE_ROOT }}/wp-content/plugins"
            
            # Clean old backups (keep last 5)
            echo "๐งน Cleaning old backups..."
            cd "$HOME/backups"
            ls -t | tail -n +6 | xargs -r rm -rf 2>/dev/null || true
            
            echo "โ Backup created successfully"

      # --- DEPLOY STEPS (RSYNC) ---
      
      - name: ๐ Deploy dist/
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --checksum
          path: dist/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/dist/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ๐ Deploy inc/
        if: hashFiles('inc/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --checksum
          path: inc/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/inc/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ๐ Deploy theme PHP files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "functions.php,style.css,screenshot.png,header.php,footer.php,index.php"
          target: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/
          strip_components: 0

      # DEPLOY PLUGINS (Now deploying pre-built artifacts)
      - name: ๐ Deploy custom plugins
        uses: burnett01/rsync-deployments@5.2.1
        with:
          # Ensure 'vendor' is NOT excluded so dependencies are uploaded
          switches: -avzr --checksum --exclude='index.php' --exclude='*.md'
          path: plugins/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/plugins/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- PUBLIC ASSETS ---
      - name: ๐ Prepare public assets
        if: hashFiles('public/**') != ''
        run: |
          echo "๐ Preparing public assets..."
          SAFE_FILES=("robots.txt" "ai-bots.txt" "favicon.ico" "favicon.svg" "apple-touch-icon.png" "site.webmanifest")
          mkdir -p temp_public
          for file in "${SAFE_FILES[@]}"; do
            if [ -f "public/$file" ]; then
              cp "public/$file" temp_public/
              echo "  โ $file"
            fi
          done
          if [ -z "$(ls -A temp_public 2>/dev/null)" ]; then
            echo "โน๏ธ No public assets to deploy"
            touch temp_public/.gitkeep
          fi

      - name: ๐ Deploy public assets
        if: hashFiles('public/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avz --ignore-missing-args
          path: temp_public/
          remote_path: ${{ env.REMOTE_ROOT }}/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- CACHE PURGE ---
      - name: ๐งน Purge LiteSpeed Cache
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "๐งน Purging LiteSpeed Cache..."
            cd ${{ env.REMOTE_ROOT }}
            if command -v wp &> /dev/null; then
              wp litespeed-purge all 2>/dev/null || echo "โ๏ธ LiteSpeed Cache plugin not found"
            else
              echo "โ๏ธ WP-CLI not available"
            fi

      # --- VERIFICATION ---
      - name: ๐ Deployment summary
        if: always()
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          if [ "${{ job.status }}" = "success" ]; then
            echo "โ DEPLOYMENT SUCCESSFUL"
            echo ""
            echo "๐ Site: ${{ env.SITE_URL }}"
            echo "๐ฆ Commit: ${{ needs.build.outputs.commit_hash }}"
            echo ""
            echo "๐ Your site is now live!"
          else
            echo "โ DEPLOYMENT FAILED"
            echo "Check logs above."
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# JOB 3: HEALTH CHECK
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  health-check:
    name: ๐ฅ Health Check
    needs: deploy
    runs-on: ubuntu-24.04
    if: needs.deploy.result == 'success'
    
    steps:
      - name: ๐ Check site accessibility
        run: |
          echo "๐ Checking site accessibility..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 30 \
            -H "User-Agent: Mozilla/5.0 (compatible; DeployBot/1.0; +https://github.com)" \
            ${{ env.SITE_URL }})
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "โ Site is accessible (HTTP $HTTP_CODE)"
          else
            echo "โ๏ธ Site returned HTTP $HTTP_CODE"
            # Don't fail job for 403 (firewall) or other soft errors
            if [ "$HTTP_CODE" != "403" ]; then exit 1; fi
          fi
