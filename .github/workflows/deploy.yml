name: üöÄ Deploy WordPress Headless Theme
on:
  push:
    branches:
      - main
  workflow_dispatch:
env:
  NODE_VERSION: '18'
  WP_THEME_SLUG: 'zentheme'
  WP_PLUGINS_DIR: 'plugins'
  WP_INC_DIR: 'inc'
jobs:
  build:
    name: üèóÔ∏è Build Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: |
          echo "üì¶ Installing npm dependencies..."
          npm ci
      
      - name: üî® Build with Vite
        run: |
          echo "üî® Building production bundle..."
          npm run build
          echo "Build size:"
          du -sh dist/
      
      - name: ‚úÖ Validate build output
        run: |
          echo "Validando build..."
          test -d dist || exit 1
          test -f dist/index.html || exit 1
          echo "‚úÖ Build validation passed"
      
      - name: üì§ Upload production artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            inc/
            plugins/
            style.css
            functions.php
            screenshot.png
            README.md
          retention-days: 1
          if-no-files-found: error
  
  backup:
    name: üíæ Backup Current Theme
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    continue-on-error: true
    
    steps:
      - name: üîë Setup SSH for backup
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ö†Ô∏è SSH_PRIVATE_KEY not configured, skipping SSH setup"
            exit 0
          fi
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: üíæ Create remote backup
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ] || [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "‚ö†Ô∏è SSH credentials not configured, skipping backup"
            exit 0
          fi
          BACKUP_DIR="zentheme_backup_$(date +%Y%m%d_%H%M%S)"
          ssh -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes && \
             if [ -d zentheme ]; then \
               cp -r zentheme \"$BACKUP_DIR\" && \
               echo '‚úÖ Backup created: $BACKUP_DIR' && \
               ls -lah | grep zentheme; \
             else \
               echo '‚ö†Ô∏è No existing theme to backup'; \
             fi"
        continue-on-error: true
  
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, backup]
    if: always() && needs.build.result == 'success'
    timeout-minutes: 15
    
    steps:
      - name: üì• Download production artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build
      
      - name: üìÇ List deployment files
        run: |
          echo "Files to deploy:"
          ls -laR
      
      - name: üöÄ Deploy via FTP
        id: ftp-deploy
        uses: SamKirkland/FTP-Deploy-Action@v4
        continue-on-error: true
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: ./
          server-dir: /public_html/wp-content/themes/zentheme/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.github/**
            **/docs/**
            **/*.md
            **/LICENSE
            **/package*.json
            **/tsconfig*.json
            **/vite.config.*
            **/public/**
            **/src/**
      
      - name: üîë Setup SSH (fallback)
        if: always()
        run: |
          if [ "${{ steps.ftp-deploy.outcome }}" != "failure" ]; then
            echo "‚úÖ FTP deployment succeeded, skipping SSH setup"
            exit 0
          fi
          echo "‚ö†Ô∏è FTP deployment failed, switching to SSH/rsync..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "‚úÖ SSH key configured"
      
      - name: üöÄ Deploy via SSH/rsync (fallback)
        if: always()
        run: |
          if [ "${{ steps.ftp-deploy.outcome }}" != "failure" ]; then
            echo "‚úÖ FTP deployment succeeded, skipping SSH deployment"
            exit 0
          fi
          echo "üöÄ Deploying via rsync over SSH..."
          
          # Validate required secrets
          if [ -z "${{ secrets.SSH_HOST }}" ] || [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "‚ùå Error: SSH_HOST and SSH_USER secrets are required"
            exit 1
          fi
          
          # Set variables
          SSH_PORT=${{ secrets.SSH_PORT || 22 }}
          REMOTE_PATH="${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes/zentheme/"
          
          echo "Deploying to: ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_PATH"
          
          # Create remote directory if it doesn't exist
          ssh -p $SSH_PORT ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p $REMOTE_PATH"
          
          # Deploy using rsync
          rsync -avz --delete \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='.vscode' \
            --exclude='.github' \
            --exclude='docs' \
            --exclude='*.md' \
            --exclude='LICENSE' \
            --exclude='package*.json' \
            --exclude='tsconfig*.json' \
            --exclude='vite.config.*' \
            --exclude='public' \
            --exclude='src' \
            -e "ssh -p $SSH_PORT" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$REMOTE_PATH
          
          echo "‚úÖ Rsync deployment completed"
      
      - name: üîê Set remote permissions
        if: always()
        run: |
          if [ "${{ steps.ftp-deploy.outcome }}" != "failure" ]; then
            echo "‚úÖ FTP deployment succeeded, skipping permission setting"
            exit 0
          fi
          echo "Setting correct file permissions..."
          ssh -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.REMOTE_WP_ROOT }}/wp-content/themes/zentheme && \
             find . -type f -exec chmod 644 {} \; && \
             find . -type d -exec chmod 755 {} \; && \
             echo '‚úÖ Permissions set correctly'"
        continue-on-error: true
      
      - name: ‚úÖ Deployment status
        run: |
          if [ "${{ steps.ftp-deploy.outcome }}" == "success" ]; then
            echo "‚úÖ Deployment completed via FTP"
          else
            echo "‚úÖ Deployment completed via SSH/rsync (FTP fallback)"
          fi
  
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10
    
    steps:
      - name: üåê Check site accessibility
        run: |
          echo "Checking website..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://djzeneyer.com || echo "000")
          echo "HTTP Status: $HTTP_CODE"
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "‚úÖ Site is accessible"
          else
            echo "‚ö†Ô∏è Site returned status $HTTP_CODE"
          fi
      
      - name: üîå Check WordPress REST API
        run: |
          echo "Checking WordPress REST API..."
          curl -s https://djzeneyer.com/wp-json/ | jq . || echo "REST API check failed"
      
      - name: üéØ Check custom REST endpoint
        run: |
          echo "Checking custom REST endpoint..."
          curl -s https://djzeneyer.com/wp-json/djz/v1/config | jq . || echo "Custom endpoint check failed"
      
      - name: üìÑ Check robots.txt
        run: |
          echo "Checking robots.txt for SEO..."
          curl -s https://djzeneyer.com/robots.txt | grep -q "User-agent" && echo "‚úÖ robots.txt OK" || echo "‚ö†Ô∏è robots.txt issue"
      
      - name: ‚úÖ Health check completed
        run: echo "üéâ All health checks passed!"
