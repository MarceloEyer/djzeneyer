name: Production Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Pular build (usar artefato existente)'
        required: false
        default: 'false'
        type: boolean
      force_deploy:
        description: 'Forçar deploy mesmo sem mudanças'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: 20
  SSH_HOST: 147.79.84.222
  SSH_PORT: 65002
  SSH_USER: u790739895
  REMOTE_ROOT: /home/u790739895/domains/djzeneyer.com/public_html
  THEME_NAME: zentheme
  SITE_URL: https://djzeneyer.com

jobs:
  pre-build-validation:
    name: Validação de Pré-compilação
    runs-on: ubuntu-24.04
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      commit_hash: ${{ steps.commit.outputs.commit_hash }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Obter hash do commit
        id: commit
        run: |
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Detectar mudanças relevantes
        id: check
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep -E '\.(ts|tsx|js|jsx|css|scss|json|html)$' || true)
          
          if [ -n "$CHANGED_FILES" ] || [ "${{ inputs.force_deploy }}" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Alterações detectadas - compilação necessária"
            echo "Arquivos: $CHANGED_FILES"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "Nenhuma alteração de compilação detectada"
          fi

      - name: Verificar arquivos críticos
        run: |
          REQUIRED_FILES=(
            "package.json"
            "vite.config.ts"
            "tsconfig.json"
            "tailwind.config.js"
            "src/main.tsx"
            "functions.php"
          )
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Arquivo necessário ausente: $file"
              exit 1
            fi
          done
          echo "Todos os arquivos necessários presentes"

      - name: Validar segredos
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Segredo SSH_PRIVATE_KEY não definido!"
            exit 1
          fi
          if [ -z "${{ secrets.VITE_WC_CONSUMER_KEY }}" ]; then
            echo "Aviso: VITE_WC_CONSUMER_KEY não definido"
          fi
          echo "Segredos críticos validados"

  build-production:
    name: Build Production
    needs: pre-build-validation
    if: needs.pre-build-validation.outputs.should_build == 'true' || inputs.skip_build == 'false'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Instalar dependências
        run: npm ci

      - name: Build com Vite
        env:
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
        run: npm run build

      - name: Upload artefato
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ needs.pre-build-validation.outputs.commit_hash }}
          path: |
            dist/
            inc/
            assets/
            functions.php
            style.css
            screenshot.png
          retention-days: 7

  deploy-to-production:
    name: Deploy to Production
    needs: [pre-build-validation, build-production]
    if: always() && (needs.pre-build-validation.outputs.should_build == 'true' || inputs.force_deploy == 'true')
    runs-on: ubuntu-24.04
    environment:
      name: production
      url: ${{ env.SITE_URL }}

    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github
          sparse-checkout-cone-mode: false

      - name: Baixar artefato do build
        uses: actions/download-artifact@v4
        with:
          name: build-${{ needs.pre-build-validation.outputs.commit_hash }}
          path: ./

      - name: Configurar chave SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary
          name: id_rsa
          if_key_exists: replace

      - name: Testar conexão SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo 'SSH connection successful'
            pwd && whoami

      - name: Preparar servidor remoto
        id: prepare
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/deploy_${TIMESTAMP}"
            THEME_PATH="${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}"

            # Backup do tema atual
            mkdir -p "${BACKUP_DIR}"
            if [ -d "${THEME_PATH}" ]; then
              echo "Fazendo backup do tema atual..."
              tar -czf "${BACKUP_DIR}/theme_backup.tar.gz" -C "${THEME_PATH}" . 2>/dev/null || true
            fi

            # Garante estrutura do tema
            mkdir -p "${THEME_PATH}/dist" "${THEME_PATH}/inc" "${THEME_PATH}/assets"

            # Corrige permissões (crítico!)
            echo "Corrigindo permissões do wp-content..."
            chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} "${{ env.REMOTE_ROOT }}/wp-content" || true
            chmod -R 755 "${{ env.REMOTE_ROOT }}/wp-content"

            # Limpa backups antigos (máx 5)
            cd "$HOME/backups" && ls -t | tail -n +6 | xargs -r rm -rf 2>/dev/null || true

            echo "${BACKUP_DIR}" > /tmp/last_backup_path.txt
            echo "Servidor remoto pronto para deploy"

      - name: Deploy via rsync
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --exclude=".*" --exclude="node_modules"
          path: .
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Health Check
        run: |
          sleep 5
          curl -f -s -o /dev/null "${{ env.SITE_URL }}" && echo "Site está online" || exit 1

      - name: Resumo final
        run: |
          echo "════════════════════════════════════════"
          if [ "${{ job.status }}" = "success" ]; then
            echo "DEPLOY SUCCESSFUL | Commit: ${{ needs.pre-build-validation.outputs.commit_hash }}"
          else
            echo "DEPLOY FAILED | See logs"
          fi
          echo "════════════════════════════════════════"

      - name: Notificar falha (apenas em PR)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Deploy failed! Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            })
