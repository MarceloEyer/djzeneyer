# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ DJ ZEN EYER - PRODUCTION DEPLOY (RESTORED v4.1 + PRERENDER FIX)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LÃ³gica: Baseada estritamente no log de sucesso v4.1
# AdiÃ§Ãµes: Prerender (Build) e Sync de Imagens (Deploy)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸš€ Production Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build (use existing artifact)'
        required: false
        type: boolean
        default: false

concurrency:
  group: production-deploy
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: 20
  SSH_HOST: 147.79.84.222
  SSH_PORT: 65002
  SSH_USER: u790739895
  REMOTE_ROOT: /home/u790739895/domains/djzeneyer.com/public_html
  THEME_NAME: zentheme
  SITE_URL: https://djzeneyer.com

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    if: ${{ !inputs.skip_build }}
    
    outputs:
      commit_hash: ${{ steps.commit.outputs.hash }}
      build_timestamp: ${{ steps.timestamp.outputs.value }}
      build_status: ${{ job.status }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”– Generate metadata
        id: commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: â° Generate timestamp
        id: timestamp
        run: echo "value=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ºï¸ Generate sitemaps
        run: |
          echo "ğŸ—ºï¸ Generating sitemaps..."
          npm run generate-sitemaps
          # ValidaÃ§Ã£o mÃ­nima
          if [ ! -f "public/sitemap.xml" ]; then echo "âŒ sitemap.xml missing"; exit 1; fi
          echo "âœ… Sitemaps generated successfully"

      - name: ğŸ”¨ Build production
        env:
          NODE_ENV: production
          VITE_WP_SITE_URL: ${{ env.SITE_URL }}
          VITE_WP_REST_URL: ${{ env.SITE_URL }}/wp-json/
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
        run: npm run build

      # â­ ADIÃ‡ÃƒO: PRERENDER (ObrigatÃ³rio para evitar tela branca)
      - name: ğŸ¨ Prerender pages (SSG)
        run: |
          echo "ğŸ¨ Starting prerender..."
          if ! npm list puppeteer >/dev/null 2>&1; then npm install puppeteer; fi
          node scripts/prerender.js
          if [ ! -f "dist/index.html" ]; then echo "âŒ Prerender failed"; exit 1; fi
          echo "âœ… Prerender OK"

      - name: âœ… Validate build
        run: |
          if [ ! -d dist ]; then echo "âŒ dist/ not found"; exit 1; fi
          if [ ! -f dist/index.html ]; then echo "âŒ dist/index.html not found"; exit 1; fi
          echo "âœ… Build validation passed"

      # --- PLUGIN DEPENDENCIES ---
      - name: ğŸ”¨ Build plugin dependencies
        run: |
          echo "ğŸ“¦ Building plugins..."
          if [ -d "plugins" ]; then
            for dir in plugins/*/; do
              if [ -f "$dir/composer.json" ]; then
                cd "$dir"
                composer install --no-dev --optimize-autoloader --ignore-platform-reqs --no-interaction
                rm -rf tests/ .git/ .github/ .gitignore
                cd - > /dev/null
              fi
            done
          fi

      # --- ARTIFACTS ---
      - name: ğŸ“¤ Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-dist-${{ steps.commit.outputs.hash }}
          path: dist/
          include-hidden-files: true
          retention-days: 7
          compression-level: 6

      - name: ğŸ“¤ Upload theme files
        uses: actions/upload-artifact@v4
        with:
          name: build-theme-${{ steps.commit.outputs.hash }}
          path: |
            functions.php
            style.css
            screenshot.png
            header.php
            footer.php
            index.php
          retention-days: 7

      - name: ğŸ“¤ Upload plugins
        if: hashFiles('plugins/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: build-plugins-${{ steps.commit.outputs.hash }}
          path: plugins/
          retention-days: 7

      - name: ğŸ“¤ Upload sitemaps
        uses: actions/upload-artifact@v4
        with:
          name: build-sitemaps-${{ steps.commit.outputs.hash }}
          path: |
            public/sitemap.xml
            public/sitemap-pages.xml
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: DEPLOY (RESTAURADO DO LOG ORIGINAL)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy
    needs: build
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    if: |
      always() && 
      (needs.build.result == 'success' || inputs.skip_build)
    
    environment:
      name: production
      url: ${{ env.SITE_URL }}
    
    steps:
      - name: ğŸ“¥ Checkout (sparse)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            inc
            public
            parts
            templates
          sparse-checkout-cone-mode: false

      # --- DOWNLOAD ARTIFACTS ---
      - name: ğŸ“¥ Download dist
        if: ${{ !inputs.skip_build }}
        uses: actions/download-artifact@v4
        with:
          name: build-dist-${{ needs.build.outputs.commit_hash }}
          path: ./dist

      - name: ğŸ“¥ Download theme files
        if: ${{ !inputs.skip_build }}
        uses: actions/download-artifact@v4
        with:
          name: build-theme-${{ needs.build.outputs.commit_hash }}
          path: ./

      - name: ğŸ“¥ Download plugins
        if: ${{ !inputs.skip_build }}
        uses: actions/download-artifact@v4
        with:
          name: build-plugins-${{ needs.build.outputs.commit_hash }}
          path: ./plugins

      - name: ğŸ“¥ Download sitemaps
        if: ${{ !inputs.skip_build }}
        uses: actions/download-artifact@v4
        with:
          name: build-sitemaps-${{ needs.build.outputs.commit_hash }}
          path: ./sitemaps-deploy

      # --- SSH SETUP ---
      - name: ğŸ” Setup SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary
          name: id_rsa

      # --- BACKUP & CLEANUP ---
      - name: ğŸ“¦ Backup & Clean dist folder
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/deploy_${TIMESTAMP}"
            THEME_PATH="${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}"
            
            echo "ğŸ“¦ BACKUP & CLEANUP"
            mkdir -p "${BACKUP_DIR}"
            if [ -d "${THEME_PATH}/dist" ]; then
              tar -czf "${BACKUP_DIR}/dist_backup.tar.gz" -C "${THEME_PATH}" dist/ 2>/dev/null || true
              rm -rf "${THEME_PATH}/dist"/*
            fi
            mkdir -p "${THEME_PATH}/dist"
            mkdir -p "${{ env.REMOTE_ROOT }}/wp-content/plugins"
            
            # Cleanup old backups
            cd "$HOME/backups"
            ls -t | tail -n +6 | xargs -r rm -rf 2>/dev/null || true
            echo "âœ… Cleanup done"

      # --- DEPLOY STEPS (IGUAL AO ORIGINAL v4.1) ---
      
      - name: ğŸš€ Deploy dist/
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --checksum
          path: dist/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/dist/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ESTE PASSO Ã‰ O SEGREDO QUE ESTAVA FALTANDO! ğŸ‘‡
      - name: ğŸ“š Deploy inc/
        if: hashFiles('inc/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --checksum
          path: inc/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/inc/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ADICIONADO PARA GARANTIR TEMAS MODERNOS
      - name: ğŸ“š Deploy parts/
        if: hashFiles('parts/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --checksum
          path: parts/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/parts/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“š Deploy templates/
        if: hashFiles('templates/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --checksum
          path: templates/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/templates/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“ Deploy theme PHP files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "functions.php,style.css,screenshot.png,header.php,footer.php,index.php"
          target: ${{ env.REMOTE_ROOT }}/wp-content/themes/${{ env.THEME_NAME }}/
          strip_components: 0

      - name: ğŸ”Œ Deploy plugins
        if: hashFiles('plugins/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --checksum --exclude='*.md' --exclude='tests/' --exclude='.git/'
          path: plugins/
          remote_path: ${{ env.REMOTE_ROOT }}/wp-content/plugins/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- PUBLIC ASSETS & IMAGES FIX ---
      - name: ğŸ“„ Prepare public assets
        if: hashFiles('public/**') != ''
        run: |
          echo "ğŸ“„ Preparing public assets..."
          mkdir -p temp_public
          
          # Arquivos bÃ¡sicos
          SAFE_FILES=("robots.txt" "ai-bots.txt" "favicon.ico" "favicon.svg" "apple-touch-icon.png" "site.webmanifest")
          for file in "${SAFE_FILES[@]}"; do
            if [ -f "public/$file" ]; then cp "public/$file" temp_public/; fi
          done
          
          # â­ CORREÃ‡ÃƒO CRÃTICA: Copiar pasta de IMAGENS
          if [ -d "public/images" ]; then
             echo "  âœ“ Including images/ folder"
             cp -r "public/images" temp_public/
          fi

          # Copiar .well-known
          if [ -d "public/.well-known" ]; then
             cp -r "public/.well-known" temp_public/
          fi

      - name: ğŸ“„ Deploy public assets
        if: hashFiles('public/**') != ''
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avz --ignore-missing-args
          path: temp_public/
          remote_path: ${{ env.REMOTE_ROOT }}/
          remote_host: ${{ env.SSH_HOST }}
          remote_user: ${{ env.SSH_USER }}
          remote_port: ${{ env.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- SITEMAPS ---
      - name: ğŸ—ºï¸ Deploy sitemaps to ROOT
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "sitemaps-deploy/sitemap.xml,sitemaps-deploy/sitemap-pages.xml"
          target: ${{ env.REMOTE_ROOT }}/
          strip_components: 1

      # --- CACHE PURGE ---
      - name: ğŸ§¹ Purge caches
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          port: ${{ env.SSH_PORT }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ env.REMOTE_ROOT }}
            if command -v wp &> /dev/null; then wp litespeed-purge all 2>/dev/null; fi
            if php -r "opcache_reset();" 2>/dev/null; then echo "âœ… OPcache flushed"; else curl -s "${{ env.SITE_URL }}/?opcache_reset=1" -o /dev/null; fi

      - name: ğŸ‰ Success
        if: success()
        run: echo "ğŸš€ Site Live at ${{ env.SITE_URL }}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 3: HEALTH CHECK (Mantido Original)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-check:
    name: ğŸ¥ Health Check
    needs: deploy
    runs-on: ubuntu-24.04
    if: needs.deploy.result == 'success'
    
    steps:
      - name: ğŸ” Check sitemap.xml
        run: |
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 30 -H "User-Agent: $UA" ${{ env.SITE_URL }}/sitemap.xml)
          if [ "$HTTP_CODE" = "200" ]; then echo "âœ… Site UP"; else echo "âš ï¸ HTTP $HTTP_CODE"; exit 0; fi
