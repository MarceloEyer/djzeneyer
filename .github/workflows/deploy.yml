name: ğŸš€ Deploy to Hostinger

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
      
      - name: ğŸ”¨ Build with Vite
        run: |
          echo "ğŸ”¨ Building project with Vite..."
          npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸ“Š Build summary
        run: |
          echo "âœ… Build completed successfully"
          echo "ğŸ“¦ Build size:"
          du -sh dist/ || echo "dist/ directory not found"
          ls -la dist/ || echo "No dist/ contents to display"
      
      - name: ğŸš€ Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          local-dir: ./dist/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.idea/**
            **/README.md
      
      - name: âœ… Deployment summary
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo ""
          echo "ğŸŒ Site: https://djzeneyer.com"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸš€ Deployed via FTP to Hostinger"
          echo "ğŸ“ Target: ${{ secrets.FTP_SERVER_DIR }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
      
      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo "âŒ DEPLOYMENT FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo ""
          echo "Please check the logs above for error details"
          echo "Common issues:"
          echo "  - FTP credentials incorrect"
          echo "  - Server directory doesn't exist"
          echo "  - Network connectivity issues"
          echo "  - Build artifacts missing"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="

  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ” Check site accessibility
        run: |
          echo "Checking https://djzeneyer.com..."
          for i in {1..3}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 15 https://djzeneyer.com)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Site is accessible (HTTP $HTTP_CODE)"
              exit 0
            else
              echo "âš ï¸ Attempt $i: HTTP $HTTP_CODE"
              [ $i -lt 3 ] && sleep 5
            fi
          done
          echo "âš ï¸ Site check inconclusive but deployment completed"
      
      - name: ğŸ‰ Final status
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo "ğŸ‰ WORKFLOW COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo ""
          echo "ğŸŒ Live site: https://djzeneyer.com"
          echo "ğŸ“ Workflow: ${{ github.workflow }}"
          echo "ğŸ”— Run: ${{ github.run_number }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
