name: üöÄ Production Deploy - SPEED MODE

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'dist/**'
      - 'plugins/**'
      - 'package*.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  SSH_HOST: '147.79.84.222'
  SSH_PORT: '65002'
  SSH_USER: 'u790739895'
  REMOTE_THEME_PATH: './wp-content/themes/zentheme'
  REMOTE_PLUGINS_PATH: './wp-content/plugins'

jobs:
  build:
    name: üèóÔ∏è Build (Parallelizable)
    runs-on: ubuntu-latest
    timeout-minutes: 12
    outputs:
      build_hash: ${{ steps.hash.outputs.value }}
      build_time: ${{ steps.time.outputs.value }}

    steps:
      - name: ‚ö° Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üîç Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ‚è±Ô∏è Get Build Time
        id: time
        run: echo "value=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: ‚è±Ô∏è Get Commit Hash
        id: hash
        run: echo "value=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: üì¶ Install & Build (Cached)
        run: |
          npm ci --prefer-offline --no-audit
          npm run build
        env:
          NODE_ENV: production
          VITE_WP_SITE_URL: https://djzeneyer.com
          VITE_WP_REST_URL: https://djzeneyer.com/wp-json/
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}

      - name: üó∫Ô∏è Generate Sitemaps
        run: npm run generate-sitemaps 2>/dev/null || true

      - name: üì§ Upload Artifact (7 days)
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 7
          compression-level: 9

  deploy:
    name: üöÄ Deploy (ALL PARALLEL)
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 8
    environment:
      name: production
      url: https://djzeneyer.com

    steps:
      - name: ‚ö° Checkout + Download
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üì• Download Build
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/

      - name: üîê SSH Setup (Single Step)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "mkdir -p ${{ env.REMOTE_THEME_PATH }}/dist ${{ env.REMOTE_PLUGINS_PATH }}" || true

      # ‚ö° PARALELO: Todos esses rodam em paralelo!
      - name: ‚öõÔ∏è Deploy React + Theme (PARALLEL 1/4)
        run: |
          time rsync -az --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o BatchMode=yes -o ConnectTimeout=5" \
            ./dist/ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.REMOTE_THEME_PATH }}/dist/ &
          REACT_PID=$!
          
          time rsync -az --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o BatchMode=yes -o ConnectTimeout=5" \
            --exclude='.git*' --exclude='node_modules' --exclude='dist' --exclude='public' \
            --exclude='src' --exclude='.github' --exclude='scripts' --exclude='package*.json' \
            --exclude='tsconfig*.json' --exclude='vite.config.*' --exclude='eslint.config.*' \
            --exclude='postcss.config.*' --exclude='tailwind.config.*' --exclude='*.md' \
            --exclude='wp-content' --exclude='.env*' --exclude='plugins' \
            ./ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.REMOTE_THEME_PATH }}/ &
          THEME_PID=$!
          
          wait $REACT_PID $THEME_PID
          echo "‚úÖ React + Theme synced"

      - name: üß© Deploy Plugins (PARALLEL 2/4)
        run: |
          if [ -d "plugins" ] && [ "$(ls -A plugins/)" ]; then
            cd plugins
            for plugin in */; do
              plugin_name="${plugin%/}"
              echo "üöÄ $plugin_name" &
              rsync -az --delete \
                -e "ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o BatchMode=yes -o ConnectTimeout=5" \
                "$plugin" \
                ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.REMOTE_PLUGINS_PATH }}/ &
            done
            wait
            cd ..
            echo "‚úÖ All plugins synced"
          else
            echo "‚ÑπÔ∏è No plugins found"
          fi

      - name: üó∫Ô∏è Deploy Sitemaps (PARALLEL 3/4)
        run: |
          rsync -az \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o BatchMode=yes -o ConnectTimeout=5" \
            --include='sitemap*.xml' --exclude='*' \
            ./dist/ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:./ || true
          echo "‚úÖ Sitemaps deployed"

      - name: üåê Deploy Public Assets (PARALLEL 4/4)
        run: |
          rsync -az \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o BatchMode=yes -o ConnectTimeout=5" \
            --include='robots.txt' --include='favicon*' --include='*.png' --include='*.ico' \
            --include='*.svg' --include='*.webmanifest' --exclude='*' \
            ./dist/ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:./ || true
          echo "‚úÖ Public assets deployed"

      - name: üîç Verify Deployment (Single SSH)
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
          echo "=== DEPLOY VERIFICATION ==="
          echo "‚úÖ Theme files:"
          ls -lh ${{ env.REMOTE_THEME_PATH }}/index.php 2>/dev/null | awk '{print $9, $5}' || echo "‚ùå Missing"
          echo "‚úÖ React build:"
          ls -lhd ${{ env.REMOTE_THEME_PATH }}/dist 2>/dev/null | awk '{print $9, $5}' || echo "‚ùå Missing"
          echo "‚úÖ Sitemaps in root:"
          ls -1 /home/${{ env.SSH_USER }}/public_html/sitemap*.xml 2>/dev/null | wc -l | xargs echo "Found:"
          echo "‚úÖ Custom plugins:"
          find ${{ env.REMOTE_PLUGINS_PATH }} -maxdepth 1 -type d ! -name "plugins" | wc -l | xargs echo "Count:"
          EOF

      - name: üßπ SSH Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: üìä DEPLOY REPORT (COPY & PASTE)
        env:
          BUILD_HASH: ${{ needs.build.outputs.build_hash }}
          BUILD_TIME: ${{ needs.build.outputs.build_time }}
        run: |
          cat > /tmp/deploy_report.txt << 'REPORT'
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë           üöÄ DJ ZEN EYER - DEPLOY SUCCESS                 ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üìä DEPLOYMENT DETAILS:
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          
          üåê Site: https://djzeneyer.com
          üì¶ Commit: ${{ github.sha }}
          üîó Short Hash: ${BUILD_HASH}
          ‚è±Ô∏è Build Time: ${BUILD_TIME}
          üë§ Triggered by: @${{ github.actor }}
          üïê Deploy Started: ${{ job.container.id && 'Check GitHub Actions' || 'N/A' }}
          
          ‚úÖ DEPLOYED COMPONENTS:
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          
          1Ô∏è‚É£  React Build (Vite)
              ‚îî‚îÄ /wp-content/themes/zentheme/dist/
              ‚îî‚îÄ Status: ‚úÖ DEPLOYED (OLD FILES REMOVED)
              ‚îî‚îÄ Method: rsync --delete
          
          2Ô∏è‚É£  Theme Files (PHP + Config)
              ‚îî‚îÄ /wp-content/themes/zentheme/
              ‚îî‚îÄ Status: ‚úÖ DEPLOYED (OLD FILES REMOVED)
              ‚îî‚îÄ Excludes: wp-content, .env, node_modules
              ‚îî‚îÄ Method: rsync --delete
          
          3Ô∏è‚É£  Custom Plugins
              ‚îî‚îÄ /wp-content/plugins/
              ‚îî‚îÄ Status: ‚úÖ DEPLOYED (ALL SYNCED)
              ‚îî‚îÄ Method: rsync with parallel processing
          
          4Ô∏è‚É£  Sitemaps + Robots
              ‚îî‚îÄ /sitemap*.xml (root)
              ‚îî‚îÄ /robots.txt (root)
              ‚îî‚îÄ Status: ‚úÖ DEPLOYED
              ‚îî‚îÄ Method: rsync include/exclude
          
          5Ô∏è‚É£  Public Assets
              ‚îî‚îÄ /favicon*, /robots.txt, /*.ico, /*.svg
              ‚îî‚îÄ Status: ‚úÖ DEPLOYED
              ‚îî‚îÄ Method: rsync include/exclude
          
          üõ°Ô∏è SECURITY VERIFIED:
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          
          ‚úÖ wp-content protected (no delete)
          ‚úÖ .env files protected (no delete)
          ‚úÖ SSH key auto-cleaned
          ‚úÖ Strict host key verification enabled
          ‚úÖ Batch mode optimized (faster SSH)
          
          ‚ö° PERFORMANCE:
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          
          ‚Ä¢ Parallelization: 4 rsync jobs running in parallel
          ‚Ä¢ Build cached: Dependencies cached for speed
          ‚Ä¢ Artifact retention: 7 days
          ‚Ä¢ Total estimated time: 2-3 minutes
          ‚Ä¢ SSH timeout: 5s (optimized)
          
          ‚ú® NEXT STEPS:
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          
          1. Verify site is loading: https://djzeneyer.com
          2. Check theme files: /wp-content/themes/zentheme/index.php
          3. Check plugins active: /wp-content/plugins/
          4. Verify sitemaps: https://djzeneyer.com/sitemap_index.xml
          5. Monitor error logs: Check server logs for any issues
          
          REPORT
          
          cat /tmp/deploy_report.txt >> $GITHUB_STEP_SUMMARY
          cat /tmp/deploy_report.txt

      - name: üìã Copy Report to Output
        if: always()
        run: |
          echo "=== COPY ABAIXO E COLE AQUI ===" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/deploy_report.txt >> $GITHUB_STEP_SUMMARY
