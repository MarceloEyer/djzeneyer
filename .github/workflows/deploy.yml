name: ğŸš€ Production Deploy - DJ ZEN EYER v2.0

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build step (use existing artifact)'
        required: false
        type: boolean
        default: false

concurrency:
  group: production-deploy
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: '20'
  SSH_HOST: '147.79.84.222'
  SSH_PORT: '65002'
  SSH_USER: 'u790739895'
  # âœ… Caminhos ABSOLUTOS - Hostinger
  THEME_PATH: '/home/u790739895/public_html/wp-content/themes/zentheme'
  PLUGINS_PATH: '/home/u790739895/public_html/wp-content/plugins'
  WEB_ROOT: '/home/u790739895/public_html'
  BACKUP_PATH: '/home/u790739895/backups/theme'

jobs:
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ !inputs.skip_build }}
    outputs:
      status: ${{ job.status }}
      hash: ${{ steps.hash.outputs.value }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”– Get commit hash
        id: hash
        run: echo "value=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ› ï¸ Build project
        run: npm run build
        env:
          NODE_ENV: production
          VITE_WP_SITE_URL: https://djzeneyer.com
          VITE_WP_REST_URL: https://djzeneyer.com/wp-json/
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}

      - name: ğŸ“‚ Verify build output
        run: |
          [ -d dist ] && [ -f dist/index.html ] && [ -s dist/index.html ] || exit 1

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ steps.hash.outputs.value }}
          path: dist/
          retention-days: 7

  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build
    if: needs.build.result == 'success' || inputs.skip_build
    environment:
      name: production
      url: https://djzeneyer.com

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ============================================
      # DOWNLOAD & VERIFY ARTIFACT
      # ============================================

      - name: ğŸ“¥ Download build artifact
        if: ${{ !inputs.skip_build }}
        uses: actions/download-artifact@v4
        with:
          name: build-${{ needs.build.outputs.hash }}
          path: dist/

      - name: âœ… Verify artifact integrity
        if: ${{ !inputs.skip_build }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ BUILD ARTIFACT VERIFICATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ ! -d dist ] || [ ! -f dist/index.html ]; then
            echo "âŒ FAILED: Build artifact is invalid!"
            exit 1
          fi
          
          SIZE=$(du -sh dist | cut -f1)
          FILES=$(find dist -type f | wc -l)
          
          echo "âœ… Artifact valid"
          echo "   Size: $SIZE"
          echo "   Files: $FILES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # SSH SETUP & VALIDATION
      # ============================================

      - name: ğŸ”‘ Setup SSH connection
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”‘ SSH CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "âœ… SSH configured"
          echo "   Host: ${{ env.SSH_HOST }}"
          echo "   Port: ${{ env.SSH_PORT }}"
          echo "   User: ${{ env.SSH_USER }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ§ª Test SSH connection
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª SSH CONNECTION TEST"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "whoami && pwd"; then
            echo "âœ… SSH connection successful"
          else
            echo "âŒ FAILED: Cannot connect to server"
            exit 1
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # PRÃ‰-DEPLOY CHECKS
      # ============================================

      - name: ğŸ” Pre-deployment checks
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” PRE-DEPLOYMENT CHECKS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          THEME_PATH="${{ env.THEME_PATH }}"
          WEB_ROOT="${{ env.WEB_ROOT }}"
          
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'PRECHECK'
          set -e
          
          THEME_PATH="/home/u790739895/public_html/wp-content/themes/zentheme"
          WEB_ROOT="/home/u790739895/public_html"
          
          echo "âœ… Checking web root..."
          [ -d "$WEB_ROOT" ] || { echo "âŒ Web root not found"; exit 1; }
          
          echo "âœ… Checking .htaccess..."
          if [ -f "$WEB_ROOT/.htaccess" ]; then
            echo "   âœ“ .htaccess found (will be preserved)"
            HTACCESS_SIZE=$(wc -c < "$WEB_ROOT/.htaccess")
            echo "   Size: $HTACCESS_SIZE bytes"
          else
            echo "   âš ï¸  .htaccess not found (will not be modified)"
          fi
          
          echo "âœ… Checking themes directory..."
          [ -d "$WEB_ROOT/wp-content/themes" ] || { echo "âŒ Themes directory missing"; exit 1; }
          
          PRECHECK
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # BACKUP CURRENT THEME & FILES
      # ============================================

      - name: ğŸ’¾ Backup current theme & critical files
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ’¾ CREATING BACKUP"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          THEME_PATH="${{ env.THEME_PATH }}"
          BACKUP_PATH="${{ env.BACKUP_PATH }}"
          WEB_ROOT="${{ env.WEB_ROOT }}"
          
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'BACKUP'
          set -e
          
          THEME_PATH="/home/u790739895/public_html/wp-content/themes/zentheme"
          BACKUP_PATH="/home/u790739895/backups/theme"
          WEB_ROOT="/home/u790739895/public_html"
          BACKUP_TS=$(date +%Y%m%d_%H%M%S)
          
          mkdir -p "$BACKUP_PATH"
          
          # Backup tema
          if [ -d "$THEME_PATH" ]; then
            BACKUP_FILE="$BACKUP_PATH/theme_${BACKUP_TS}.tar.gz"
            echo "ğŸ“¦ Creating theme backup: theme_${BACKUP_TS}.tar.gz"
            tar -czf "$BACKUP_FILE" -C "$THEME_PATH" . 2>/dev/null || true
            
            if [ -f "$BACKUP_FILE" ]; then
              SIZE=$(du -sh "$BACKUP_FILE" | cut -f1)
              echo "âœ… Theme backup created ($SIZE)"
            fi
          else
            echo "âš ï¸  Theme directory not found (first deployment?)"
          fi
          
          # Backup .htaccess
          if [ -f "$WEB_ROOT/.htaccess" ]; then
            HTACCESS_BACKUP="$BACKUP_PATH/.htaccess_${BACKUP_TS}"
            cp "$WEB_ROOT/.htaccess" "$HTACCESS_BACKUP"
            echo "âœ… .htaccess backed up"
          fi
          
          # Cleanup: keep only 10 recent backups
          BACKUPS=$(cd "$BACKUP_PATH" 2>/dev/null && ls -t theme_*.tar.gz 2>/dev/null | tail -n +11 || true)
          if [ ! -z "$BACKUPS" ]; then
            echo "ğŸ—‘ï¸  Cleaning old theme backups..."
            echo "$BACKUPS" | xargs -r rm
          fi
          
          BACKUP
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # DEPLOY THEME FILES
      # ============================================

      - name: ğŸ“¤ Deploy theme files
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¤ DEPLOYING THEME"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          THEME_PATH="${{ env.THEME_PATH }}"
          
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'CREATE'
          THEME_PATH="/home/u790739895/public_html/wp-content/themes/zentheme"
          mkdir -p "$THEME_PATH"
          CREATE
          
          REMOTE_PATH="${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/home/u790739895/public_html/wp-content/themes/zentheme"
          
          rsync -avz --checksum -e "ssh -p ${{ env.SSH_PORT }}" \
            --exclude='.git/' \
            --exclude='.gitignore' \
            --exclude='node_modules/' \
            --exclude='build/' \
            --exclude='dist/' \
            --exclude='src/' \
            --exclude='public/' \
            --exclude='.env*' \
            --exclude='*.md' \
            --exclude='.vscode/' \
            --exclude='.github/' \
            --exclude='scripts/' \
            --exclude='test/' \
            ./ "$REMOTE_PATH/" 2>&1 | grep -E "(^sending|files transferred|total size)" || true
          
          echo "âœ… Theme files deployed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # DEPLOY BUILD (dist/)
      # ============================================

      - name: ğŸ¨ Deploy build (dist/)
        if: ${{ !inputs.skip_build }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¨ DEPLOYING BUILD (dist/)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          SIZE=$(du -sh dist | cut -f1)
          REMOTE_DIST="${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/home/u790739895/public_html/wp-content/themes/zentheme/dist"
          
          echo "ğŸ“¦ Uploading build ($SIZE)..."
          
          rsync -avz --checksum --delete \
            -e "ssh -p ${{ env.SSH_PORT }}" \
            dist/ "$REMOTE_DIST/" 2>&1 | grep -E "(^sending|files transferred|total size)" || true
          
          echo "âœ… Build deployed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # DEPLOY ASSETS (favicon, robots.txt, etc)
      # ============================================

      - name: ğŸ“¦ Deploy public assets
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ DEPLOYING PUBLIC ASSETS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          WEB_ROOT="${{ env.WEB_ROOT }}"
          
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'ASSETS'
          WEB_ROOT="/home/u790739895/public_html"
          DEPLOYED_ANY=0
          
          # Deploy robots.txt (se existir no dist/)
          if [ -f "dist/robots.txt" ]; then
            cp dist/robots.txt "$WEB_ROOT/robots.txt"
            echo "âœ… robots.txt deployed"
            DEPLOYED_ANY=1
          fi
          
          # Deploy favicon (se existir)
          if [ -f "dist/favicon.ico" ]; then
            cp dist/favicon.ico "$WEB_ROOT/favicon.ico"
            echo "âœ… favicon.ico deployed"
            DEPLOYED_ANY=1
          fi
          
          if [ $DEPLOYED_ANY -eq 0 ]; then
            echo "â„¹ï¸  No public assets to deploy"
          fi
          ASSETS
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # DEPLOY PLUGINS
      # ============================================

      - name: ğŸ”Œ Deploy plugins
        if: hashFiles('plugins/**') != ''
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”Œ DEPLOYING PLUGINS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          PLUGINS=$(find plugins -mindepth 1 -maxdepth 1 -type d -exec basename {} \;)
          
          if [ -z "$PLUGINS" ]; then
            echo "â„¹ï¸  No plugins found"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 0
          fi
          
          for plugin in $PLUGINS; do
            echo "ğŸ“¦ Deploying: $plugin"
            
            rsync -avz -e "ssh -p ${{ env.SSH_PORT }}" \
              --exclude='.git/' \
              --exclude='node_modules/' \
              "plugins/$plugin/" \
              "${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/home/u790739895/public_html/wp-content/plugins/$plugin/" \
              2>&1 | grep -E "(^sending|files transferred)" || true
          done
          
          echo "âœ… Plugins deployed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # DEPLOY SITEMAPS
      # ============================================

      - name: ğŸ“ Deploy sitemaps
        if: hashFiles('dist/sitemap*.xml') != '' && ${{ !inputs.skip_build }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ DEPLOYING SITEMAPS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          rsync -avz -e "ssh -p ${{ env.SSH_PORT }}" \
            --include='sitemap*.xml' \
            --include='robots.txt' \
            --exclude='*' \
            dist/ "${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/home/u790739895/public_html/"
          
          echo "âœ… Sitemaps deployed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # FIX PERMISSIONS
      # ============================================

      - name: ğŸ” Fix file permissions
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” FIXING FILE PERMISSIONS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          THEME_PATH="${{ env.THEME_PATH }}"
          
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'PERMS'
          THEME_PATH="/home/u790739895/public_html/wp-content/themes/zentheme"
          
          echo "ğŸ“ Setting directory permissions (755)..."
          find "$THEME_PATH" -type d -exec chmod 755 {} \;
          
          echo "ğŸ“„ Setting file permissions (644)..."
          find "$THEME_PATH" -type f -exec chmod 644 {} \;
          
          echo "âœ… Permissions fixed"
          PERMS
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # VERIFY DEPLOYMENT
      # ============================================

      - name: âœ… Verify deployment on server
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… VERIFYING DEPLOYMENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          THEME_PATH="${{ env.THEME_PATH }}"
          WEB_ROOT="${{ env.WEB_ROOT }}"
          
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'VERIFY'
          THEME_PATH="/home/u790739895/public_html/wp-content/themes/zentheme"
          WEB_ROOT="/home/u790739895/public_html"
          
          echo ""
          echo "ğŸ“ Theme path: $THEME_PATH"
          echo ""
          
          # Step 1: Verify directory exists
          echo "Step 1: Checking theme directory..."
          if [ -d "$THEME_PATH" ]; then
            echo "âœ… Theme directory exists"
          else
            echo "âŒ Theme directory NOT FOUND"
            exit 1
          fi
          
          # Step 2: Check core files
          echo ""
          echo "Step 2: Checking core theme files..."
          
          if [ -f "$THEME_PATH/functions.php" ]; then
            LINES=$(wc -l < "$THEME_PATH/functions.php")
            echo "âœ… functions.php found ($LINES lines)"
          else
            echo "âŒ functions.php NOT FOUND - ROLLBACK NEEDED"
            exit 1
          fi
          
          if [ -f "$THEME_PATH/index.php" ]; then
            echo "âœ… index.php found"
          else
            echo "âŒ index.php NOT FOUND"
            exit 1
          fi
          
          if [ -f "$THEME_PATH/style.css" ]; then
            echo "âœ… style.css found"
          else
            echo "âŒ style.css NOT FOUND"
            exit 1
          fi
          
          # Step 3: Check .htaccess integrity
          echo ""
          echo "Step 3: Checking .htaccess integrity..."
          if [ -f "$WEB_ROOT/.htaccess" ]; then
            SIZE=$(wc -c < "$WEB_ROOT/.htaccess")
            echo "âœ… .htaccess intact ($SIZE bytes)"
          else
            echo "âš ï¸  .htaccess not found"
          fi
          
          # Step 4: Check dist folder
          echo ""
          echo "Step 4: Checking dist folder..."
          
          if [ -d "$THEME_PATH/dist" ]; then
            DIST_SIZE=$(du -sh "$THEME_PATH/dist" | cut -f1)
            DIST_FILES=$(find "$THEME_PATH/dist" -type f | wc -l)
            echo "âœ… dist/ found"
            echo "   Size: $DIST_SIZE"
            echo "   Files: $DIST_FILES"
            
            if [ -f "$THEME_PATH/dist/index.html" ]; then
              SIZE=$(wc -c < "$THEME_PATH/dist/index.html")
              echo "âœ… dist/index.html exists ($SIZE bytes)"
            else
              echo "âŒ dist/index.html NOT FOUND"
              exit 1
            fi
          else
            echo "âŒ dist/ NOT FOUND"
            exit 1
          fi
          
          # Step 5: Check permissions
          echo ""
          echo "Step 5: Checking file permissions..."
          PERM=$(stat -c %a "$THEME_PATH" | head -c 3)
          if [ "$PERM" = "755" ]; then
            echo "âœ… Directory permissions correct (755)"
          else
            echo "âš ï¸  Directory permissions: $PERM"
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ALL CHECKS PASSED!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          VERIFY

      # ============================================
      # ROLLBACK ON FAILURE
      # ============================================

      - name: ğŸ”„ Rollback on failure
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”„ ROLLBACK INITIATED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          THEME_PATH="${{ env.THEME_PATH }}"
          BACKUP_PATH="${{ env.BACKUP_PATH }}"
          
          ssh -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'ROLLBACK'
          THEME_PATH="/home/u790739895/public_html/wp-content/themes/zentheme"
          BACKUP_PATH="/home/u790739895/backups/theme"
          
          LATEST_BACKUP=$(ls -t "$BACKUP_PATH"/theme_*.tar.gz 2>/dev/null | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo "âŒ No backup found for rollback"
            exit 1
          fi
          
          echo "ğŸ“¦ Restoring from: $(basename $LATEST_BACKUP)"
          rm -rf "$THEME_PATH"
          mkdir -p "$THEME_PATH"
          tar -xzf "$LATEST_BACKUP" -C "$THEME_PATH"
          
          echo "âœ… Rollback completed"
          ROLLBACK
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # CLEANUP
      # ============================================

      - name: ğŸ§¹ Cleanup SSH keys
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa ~/.ssh/config
          echo "âœ… SSH keys cleaned"

  # ============================================
  # HEALTH CHECK
  # ============================================

  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.result == 'success'

    steps:
      - name: ğŸŒ Check site accessibility
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¥ HEALTH CHECK - PRODUCTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L https://djzeneyer.com)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Site is accessible (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸  HTTP $HTTP_CODE - Check server logs"
            exit 1
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ‰ Deployment Complete
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL - v2.0"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Build:        Complete"
          echo "âœ… Theme:        Deployed"
          echo "âœ… Plugins:      Deployed"
          echo "âœ… Assets:       Deployed"
          echo "âœ… Sitemaps:     Deployed"
          echo "âœ… Permissions:  Fixed"
          echo "âœ… Verification: Passed"
          echo "âœ… Health Check: Passed"
          echo ""
          echo "ğŸš€ Your site is LIVE!"
          echo "ğŸ“ https://djzeneyer.com"
          echo "ğŸ“š Backup: Automatic"
          echo "ğŸ”„ Rollback: Available"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
