name: üöÄ DJ Zen Eyer - Deploy Simples (CORRIGIDO v4 - FINAL)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Pular o build do Vite'
        required: false
        type: boolean
        default: false

concurrency:
  group: djzeneyer-deploy
  cancel-in-progress: false

jobs:
  build:
    name: üèóÔ∏è Build Vite
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_build }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - run: npm ci --prefer-offline --no-audit
      
      - name: üé® Build Vite (COM VERIFICA√á√ÉO)
        env:
          NODE_ENV: production
          VITE_WP_SITE_URL: ${{ secrets.VITE_WP_SITE_URL }}
          VITE_WP_REST_URL: ${{ secrets.VITE_WP_REST_URL }}
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
        run: |
          echo "üìã Vers√µes:"
          node --version
          npm --version
          
          echo ""
          echo "üèóÔ∏è Buildando..."
          npm run build
          
          echo ""
          echo "‚úÖ Verificando dist/..."
          if [ -d "dist" ] && [ "$(find dist -type f | wc -l)" -gt 0 ]; then
            echo "‚úÖ dist/ existe e tem arquivos"
            echo "üìä Total: $(find dist -type f | wc -l) arquivos"
            echo "üì¶ Tamanho: $(du -sh dist)"
            ls -lah dist/ | head -10
          else
            echo "‚ùå ERRO: dist/ vazio ou n√£o existe!"
            ls -lah
            exit 1
          fi

  deploy:
    name: üöÄ Deploy para Hostinger
    runs-on: ubuntu-latest
    needs: build
    if: always() && (needs.build.result == 'success' || inputs.skip_build == true)
    
    steps:
      - uses: actions/checkout@v4

      - name: üîê Configura SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ SSH configurado"

      - name: üß™ Testa SSH
        run: |
          ssh -p ${{ secrets.SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "whoami && echo '‚úÖ SSH OK'"

      - name: üíæ Faz backup
        run: |
          ssh -p ${{ secrets.SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << 'BASH_EOF'
          THEME_PATH="${{ secrets.SSH_THEME_PATH }}"
          BACKUP_PATH="${{ secrets.SSH_BACKUP_PATH }}"
          BACKUP_TS=$(date +%Y%m%d_%H%M%S)
          
          echo "Tema path: $THEME_PATH"
          echo "Backup path: $BACKUP_PATH"
          
          if [ -d "$THEME_PATH" ]; then
            mkdir -p "$BACKUP_PATH"
            tar -czf "$BACKUP_PATH/zentheme_${BACKUP_TS}.tar.gz" -C "$THEME_PATH" . 2>/dev/null || true
            ls -t "$BACKUP_PATH"/zentheme_*.tar.gz 2>/dev/null | tail -n +11 | xargs -r rm
            echo "‚úÖ Backup criado: zentheme_${BACKUP_TS}.tar.gz"
          else
            echo "‚ö†Ô∏è  Pasta do tema n√£o existe ainda: $THEME_PATH"
          fi
          BASH_EOF

      - name: üì¶ Sincroniza dist/
        if: hashFiles('dist/**') != ''
        run: |
          echo "üöÄ Sincronizando dist/..."
          echo "   Origem: ./dist/"
          echo "   Destino: ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/dist/"
          
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            dist/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/dist/
          
          echo "‚úÖ dist/ sincronizado com sucesso"

      - name: üì¶ Sincroniza inc/
        if: hashFiles('inc/**') != ''
        run: |
          echo "üîß Sincronizando inc/..."
          echo "   Origem: ./inc/"
          echo "   Destino: ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/inc/"
          
          rsync -avz \
            -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            inc/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/inc/
          
          echo "‚úÖ inc/ sincronizado com sucesso"

      - name: üìÑ Copia functions.php
        if: hashFiles('functions.php') != ''
        run: |
          echo "‚öôÔ∏è  Copiando functions.php..."
          echo "   Origem: ./functions.php"
          echo "   Destino: ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/functions.php"
          
          scp -P ${{ secrets.SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            functions.php \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/functions.php
          
          echo "‚úÖ functions.php copiado com sucesso"

      - name: üìÑ Copia arquivos do tema
        run: |
          for file in style.css index.php screenshot.png; do
            if [ -f "$file" ]; then
              echo "Copiando $file..."
              scp -P ${{ secrets.SSH_PORT }} \
                -i ~/.ssh/id_rsa \
                -o StrictHostKeyChecking=no \
                "$file" \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_THEME_PATH }}/
              echo "‚úÖ $file copiado"
            fi
          done

      - name: üîå Sincroniza plugins/
        if: hashFiles('plugins/**') != ''
        run: |
          echo "üîå Sincronizando plugins/..."
          echo "   Origem: ./plugins/"
          echo "   Destino: ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PLUGINS_PATH }}/"
          
          rsync -avz \
            -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            plugins/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PLUGINS_PATH }}/
          
          echo "‚úÖ plugins/ sincronizado com sucesso"

      - name: üìÑ Copia arquivos p√∫blicos
        run: |
          echo "üìÑ Copiando arquivos p√∫blicos..."
          for file in robots.txt ai-bots.txt favicon.ico favicon.svg apple-touch-icon.png site.webmanifest; do
            if [ -f "public/$file" ]; then
              echo "   Copiando $file..."
              scp -P ${{ secrets.SSH_PORT }} \
                -i ~/.ssh/id_rsa \
                -o StrictHostKeyChecking=no \
                "public/$file" \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PUBLIC_PATH }}/
              echo "   ‚úÖ $file"
            fi
          done
          echo "‚úÖ Arquivos p√∫blicos copiados"

      - name: üîß Ajusta permiss√µes
        run: |
          ssh -p ${{ secrets.SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << 'BASH_EOF'
          THEME_PATH="${{ secrets.SSH_THEME_PATH }}"
          
          if [ -d "$THEME_PATH" ]; then
            echo "Ajustando permiss√µes de $THEME_PATH..."
            find "$THEME_PATH" -type d -exec chmod 755 {} \; 2>/dev/null || true
            find "$THEME_PATH" -type f -exec chmod 644 {} \; 2>/dev/null || true
            echo "‚úÖ Permiss√µes ajustadas (dirs=755, files=644)"
          else
            echo "‚ùå Caminho n√£o encontrado: $THEME_PATH"
          fi
          BASH_EOF

      - name: ‚úÖ Verifica deploy
        run: |
          ssh -p ${{ secrets.SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << 'BASH_EOF'
          echo ""
          echo "üìç Verifica√ß√£o final do deploy:"
          echo "===================================="
          THEME_PATH="${{ secrets.SSH_THEME_PATH }}"
          
          echo "Caminho do tema: $THEME_PATH"
          
          if [ -d "$THEME_PATH" ]; then
            TAMANHO=$(du -sh "$THEME_PATH" 2>/dev/null | cut -f1)
            ARQUIVOS=$(find "$THEME_PATH" -type f 2>/dev/null | wc -l)
            
            echo "Tamanho: $TAMANHO"
            echo "Total de arquivos: $ARQUIVOS"
            echo ""
            echo "‚úÖ Arquivos cr√≠ticos:"
            [ -f "$THEME_PATH/functions.php" ] && echo "  ‚úÖ functions.php" || echo "  ‚ùå functions.php N√ÉO ENCONTRADO"
            [ -d "$THEME_PATH/inc" ] && echo "  ‚úÖ inc/" || echo "  ‚ùå inc/ N√ÉO ENCONTRADO"
            [ -d "$THEME_PATH/dist" ] && echo "  ‚úÖ dist/" || echo "  ‚ùå dist/ N√ÉO ENCONTRADO"
            echo ""
            echo "üìÇ Primeiras linhas de $THEME_PATH:"
            ls -lah "$THEME_PATH" | head -10
          else
            echo "‚ùå ERRO: Caminho do tema n√£o existe!"
            echo ""
            echo "Tentando encontrar zentheme..."
            find /home -type d -name "zentheme" 2>/dev/null | head -5
          fi
          BASH_EOF

      - name: üßπ Limpa SSH
        if: always()
        run: rm -f ~/.ssh/id_rsa

      - name: üìä Resumo do Deploy
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
            echo ""
            echo "üéµ DJ Zen Eyer Theme v12.2.0"
            echo "üåê https://djzeneyer.com"
            echo "üì¶ Components Deployados:"
            echo "  ‚úì dist/ (Vite compiled React)"
            echo "  ‚úì inc/ (PHP helpers)"
            echo "  ‚úì functions.php (Theme setup)"
            echo "  ‚úì plugins/ (Custom plugins)"
            echo "  ‚úì public/ (Static assets)"
          else
            echo "‚ùå DEPLOY FALHOU"
            echo "Verifique os logs acima para detalhes"
          fi

  health-check:
    name: üè• Verifica Site
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.result == 'success'
    
    steps:
      - name: üåê Testa site
        run: |
          SITE_URL="${{ secrets.SITE_URL }}"
          echo "üîç Verificando: $SITE_URL"
          echo ""
          
          for i in 1 2 3; do
            HTTP=$(curl -s -o /dev/null -w "%{http_code}" -L "$SITE_URL" || echo "000")
            if [ "$HTTP" = "200" ]; then
              echo "‚úÖ Site online (HTTP $HTTP)"
              exit 0
            fi
            echo "‚è≥ Tentativa $i/3 (HTTP $HTTP)..."
            sleep 5
          done
          
          echo "‚ö†Ô∏è  Site pode estar em cache ou aguardando reboot"
