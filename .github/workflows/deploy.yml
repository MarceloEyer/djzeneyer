name: ğŸš€ Deploy WordPress Headless Theme
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  WP_THEME_SLUG: 'zentheme'
  WP_PLUGINS_DIR: 'plugins'
  WP_INC_DIR: 'inc'

jobs:
  build:
    name: ğŸ—ï¸ Build Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing npm dependencies..."
          npm ci
      
      - name: ğŸ”¨ Build with Vite
        run: |
          echo "ğŸ”¨ Building production bundle..."
          npm run build
          echo "Build size:"
          du -sh dist/
      
      - name: âœ… Validate build output
        run: |
          echo "Validando build..."
          test -d dist || exit 1
          test -f dist/index.html || exit 1
          echo "âœ… Build validation passed"
      
      - name: ğŸ“¤ Upload production artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            inc/
            plugins/
            style.css
            functions.php
            screenshot.png
            README.md
          retention-days: 1
          if-no-files-found: error

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Download production artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build
      
      - name: ğŸ“‚ List deployment files
        run: |
          echo "Files to deploy:"
          ls -laR
      
      - name: ğŸš€ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: ./
          server-dir: /public_html/wp-content/themes/zentheme/
          dangerous-clean-slate: true
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.github/**
            **/docs/**
            **/*.md
            **/LICENSE
            **/package*.json
            **/tsconfig*.json
            **/vite.config.*
            **/public/**
            **/src/**

  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10
    
    steps:
      - name: ğŸŒ Check site accessibility
        run: |
          echo "Checking website..."
          curl -s -o /dev/null -w "%{http_code}" https://djzeneyer.com || echo "Site check failed"
      
      - name: ğŸ”Œ Check WordPress REST API
        run: |
          echo "Checking WordPress REST API..."
          curl -s https://djzeneyer.com/wp-json/ | jq . || echo "REST API check failed"
      
      - name: ğŸ¯ Check custom REST endpoint
        run: |
          echo "Checking custom REST endpoint..."
          curl -s https://djzeneyer.com/wp-json/djz/v1/config | jq . || echo "Custom endpoint check failed"
      
      - name: ğŸ“„ Check robots.txt
        run: |
          echo "Checking robots.txt for SEO..."
          curl -s https://djzeneyer.com/robots.txt | grep -q "User-agent" && echo "âœ… robots.txt OK" || echo "âš ï¸ robots.txt issue"
      
      - name: âœ… Health check completed
        run: echo "ğŸ‰ All health checks passed!"
