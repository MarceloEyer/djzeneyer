name: ğŸš€ Build & Deploy to Hostinger (via SSH)

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write  # necessÃ¡rio para SSH com chave privada

jobs:
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    if: ${{ !inputs.skip_build }}
    
    outputs:
      commit_hash: ${{ steps.commit.outputs.hash }}
      build_timestamp: ${{ steps.timestamp.outputs.value }}
      build_status: ${{ job.status }}
    
    steps:
      - name: ğŸ“‚ Checkout do RepositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”– Generate metadata
        id: commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: â° Generate timestamp
        id: timestamp
        run: echo "value=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # --- FRONTEND BUILD ---
      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ºï¸ Generate sitemaps
        run: |
          echo "ğŸ—ºï¸ Generating sitemaps..."
          npm run generate-sitemaps
          
          # Validar que os sitemaps foram gerados
          if [ ! -f "public/sitemap.xml" ]; then
            echo "âŒ sitemap.xml not generated!"
            exit 1
          fi
          if [ ! -f "public/sitemap-pages.xml" ]; then
            echo "âŒ sitemap-pages.xml not generated!"
            exit 1
          fi
          
          echo "âœ… Sitemaps generated successfully:"
          ls -lh public/sitemap*.xml

      - name: ğŸ”¨ Build production
        env:
          VITE_WP_SITE_URL: ${{ secrets.VITE_WP_SITE_URL }}
          VITE_WP_REST_URL: ${{ secrets.VITE_WP_REST_URL }}
          VITE_WC_CONSUMER_KEY: ${{ secrets.VITE_WC_CONSUMER_KEY }}
          VITE_WC_CONSUMER_SECRET: ${{ secrets.VITE_WC_CONSUMER_SECRET }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
        run: npm run build

      - name: âœ… Validate build
        run: |
          echo "ğŸ” Validating build output..."
          
          # Verificar estrutura bÃ¡sica
          if [ ! -d dist ]; then echo "âŒ dist/ not found"; exit 1; fi
          if [ ! -f dist/index.html ]; then echo "âŒ dist/index.html not found"; exit 1; fi
          
          # Verificar manifest
          if [ ! -f "dist/.vite/manifest.json" ]; then
            echo "âŒ Vite manifest not found!"
            exit 1
          fi
          
          # Verificar assets
          JS_COUNT=$(find dist/assets -name "*.js" 2>/dev/null | wc -l)
          CSS_COUNT=$(find dist/assets -name "*.css" 2>/dev/null | wc -l)
          
          echo "ğŸ“Š Build stats:"
          echo "  - JavaScript files: $JS_COUNT"
          echo "  - CSS files: $CSS_COUNT"
          echo "  - Total size: $(du -sh dist/ | cut -f1)"
          
          if [ "$JS_COUNT" -eq 0 ] || [ "$CSS_COUNT" -eq 0 ]; then
            echo "âš ï¸ Warning: Missing JS or CSS files!"
          fi
          
          echo "âœ… Build validation passed"

      # --- PLUGIN DEPENDENCIES ---
      - name: ğŸ”¨ Build plugin dependencies
        run: |
          echo "ğŸ“¦ Installing Composer dependencies for plugins..."
          
          if [ ! -d "plugins" ]; then
            echo "â„¹ï¸ No plugins directory found"
            exit 0
          fi
          
          for dir in plugins/*/; do
            if [ -f "$dir/composer.json" ]; then
              PLUGIN_NAME=$(basename "$dir")
              echo "  â†’ Building $PLUGIN_NAME"
              
              cd "$dir"
              composer install --no-dev --optimize-autoloader --ignore-platform-reqs --no-interaction
              
              # Remover arquivos desnecessÃ¡rios
              rm -rf tests/ .git/ .github/ .gitignore
              
              cd - > /dev/null
            fi
          done
          
          echo "âœ… Plugin dependencies built"

      - name: ğŸ“¤ Upload do Artefato (dist/)
        uses: actions/upload-artifact@v4
        with:
          name: build-dist-${{ steps.commit.outputs.hash }}
          path: dist/
          include-hidden-files: true
          retention-days: 7
          compression-level: 6

      - name: ğŸ“¤ Upload theme files
        uses: actions/upload-artifact@v4
        with:
          name: build-theme-${{ steps.commit.outputs.hash }}
          path: |
            functions.php
            style.css
            screenshot.png
            header.php
            footer.php
            index.php
          retention-days: 7

      - name: ğŸ“¤ Upload plugins
        if: hashFiles('plugins/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: build-plugins-${{ steps.commit.outputs.hash }}
          path: plugins/
          retention-days: 7

      - name: ğŸ“¤ Upload sitemaps
        uses: actions/upload-artifact@v4
        with:
          name: build-sitemaps-${{ steps.commit.outputs.hash }}
          path: |
            public/sitemap.xml
            public/sitemap-pages.xml
          retention-days: 7

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 2: DEPLOY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # --- ETAPA 2: DEPLOY VIA SSH ---
  deploy:
    name: ğŸšš Deploy via SSH para Hostinger
    runs-on: ubuntu-latest
    needs: build
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    if: |
      always() && 
      (needs.build.result == 'success' || inputs.skip_build)
    
    environment:
      name: production
      url: ${{ env.SITE_URL }}
    
    steps:
      - name: ğŸ“¥ Checkout (sparse)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            inc
            public
          sparse-checkout-cone-mode: false

      - name: ğŸ“¥ Download do Artefato (dist/)
        uses: actions/download-artifact@v4
        with:
          name: build-dist-${{ needs.build.outputs.commit_hash }}
          path: ./dist

      # âœ… STEP 1: Deploy dos arquivos pÃºblicos (public/) â†’ raiz do site
      - name: ğŸ¨ Deploy de arquivos pÃºblicos para a raiz
        uses: appleboy/scp-action@v0.1.11
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./public/*"
          target: ${{ secrets.SSH_PUBLIC_PATH }}
          overwrite: true

      # âœ… STEP 2: Deploy da pasta dist/ â†’ dentro do tema
      - name: ğŸ“¡ Deploy do app React (dist/) para a pasta do tema
        uses: appleboy/scp-action@v0.1.11
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./dist/*"
          target: ${{ secrets.SSH_THEME_PATH }}/dist
          overwrite: true
          rm: true  # apaga conteÃºdo antigo da pasta dist

      # âœ… STEP 3: Deploy dos arquivos PHP do tema (root do repo) â†’ pasta do tema
      - name: ğŸ“¦ Deploy dos arquivos do tema WordPress
        uses: appleboy/scp-action@v0.1.11
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./*"
          target: ${{ secrets.SSH_THEME_PATH }}
          exclude: |
            .git,
            .github,
            node_modules,
            dist,
            public,
            .bolt,
            package*.json,
            *.md,
            *.lock,
            *.ts,
            *.tsx
          overwrite: true
